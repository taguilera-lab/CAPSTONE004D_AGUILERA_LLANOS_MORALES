{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Incidentes{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'incidents/css/incident_list.css' %}">
<script src="{% static 'incidents/js/incident_list.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - incident_list.html');
    console.log('User authenticated:', {{ user.is_authenticated|lower }});
    {% if user.is_authenticated %}
    console.log('Username:', '{{ user.username }}');
    console.log('Has flotauser:', {{ user.flotauser|yesno:"true,false" }});
    {% if user.flotauser %}
    console.log('Role name:', '{{ user.flotauser.role.name }}');
    {% endif %}
    {% endif %}
});

function changeStatus(incidentId, newStatus) {
    console.log('changeStatus called with:', incidentId, newStatus);
    if (confirm('¿Estás seguro de cambiar el status del incidente a "' + newStatus + '"?')) {
        console.log('User confirmed status change');
        // Aquí iría la lógica para cambiar el status via AJAX
        // Por ahora, solo mostramos una alerta
        alert('Funcionalidad de cambio de status próximamente disponible. Incident ID: ' + incidentId + ', Nuevo status: ' + newStatus);
    } else {
        console.log('User cancelled status change');
    }
}
</script>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">
    <i class="fas fa-exclamation-triangle"></i> Lista de Incidentes
  </h1>

  <!-- Mostrar mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Filtros -->
  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-filter"></i> Filtros
      </h5>
    </div>
    <div class="card-body">
      <form id="incident-filters" class="row g-3">
        <div class="col-md-3">
          <label for="filter-patent" class="form-label">Patente</label>
          <input type="text" class="form-control" id="filter-patent" placeholder="Buscar por patente...">
        </div>
        <div class="col-md-3">
          <label for="filter-incident-type" class="form-label">Tipo de Incidente</label>
          <select class="form-select" id="filter-incident-type">
            <option value="">Todos los tipos</option>
            <option value="Mecánica">Mecánica</option>
            <option value="Eléctrica">Eléctrica</option>
            <option value="Carrocería">Carrocería</option>
            <option value="Neumáticos">Neumáticos</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-severity" class="form-label">Severidad</label>
          <select class="form-select" id="filter-severity">
            <option value="">Todas las severidades</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
            <option value="Critica">Crítica</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-category" class="form-label">Categoría</label>
          <select class="form-select" id="filter-category">
            <option value="">Todas las categorías</option>
            <option value="Seguridad">Seguridad</option>
            <option value="Operativo">Operativo</option>
            <option value="Mantenimiento">Mantenimiento</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-status" class="form-label">Estado</label>
          <select class="form-select" id="filter-status">
            <option value="">Todos los estados</option>
            <option value="Reportada">Reportada</option>
            <option value="En_revision">En revisión</option>
            <option value="Resuelta">Resuelta</option>
            <option value="Cerrada">Cerrada</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-reported-by" class="form-label">Reportado por</label>
          <input type="text" class="form-control" id="filter-reported-by" placeholder="Buscar por nombre...">
        </div>
        <div class="col-md-3">
          <label for="filter-priority" class="form-label">Prioridad</label>
          <select class="form-select" id="filter-priority">
            <option value="">Todas las prioridades</option>
            <option value="Baja">Baja</option>
            <option value="Normal">Normal</option>
            <option value="Alta">Alta</option>
            <option value="Urgente">Urgente</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="filter-month" class="form-label">Mes</label>
          <select class="form-select" id="filter-month">
            <option value="">Todos los meses</option>
            <option value="01">Enero</option>
            <option value="02">Febrero</option>
            <option value="03">Marzo</option>
            <option value="04">Abril</option>
            <option value="05">Mayo</option>
            <option value="06">Junio</option>
            <option value="07">Julio</option>
            <option value="08">Agosto</option>
            <option value="09">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="filter-year" class="form-label">Año</label>
          <select class="form-select" id="filter-year">
            <option value="">Todos los años</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="button" class="btn btn-outline-secondary" id="clear-filters">
            <i class="fas fa-times"></i> Limpiar Filtros
          </button>
        </div>
      </form>
      <div class="mt-3">
        <small id="results-count" class="text-muted">Mostrando todos los incidentes</small>
      </div>
    </div>
  </div>

  <!-- Botones de acción según rol -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      {% if user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Vendedor' %}
        <a href="{% url 'incidents:chofer_report_incident' %}" class="btn btn-success me-2">
          <i class="fas fa-plus"></i> Reportar Incidente
        </a>
      {% elif user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Guardia' %}
        <a href="{% url 'incidents:guardia_report_incident' %}" class="btn btn-success me-2">
          <i class="fas fa-plus"></i> Reportar Incidente
        </a>
      {% elif user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Recepcionista de Vehículos' %}
        <span class="text-muted">Como recepcionista, puedes generar órdenes de trabajo para incidentes específicos</span>
      {% elif user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Supervisor' %}
        <span class="text-muted">Como supervisor, puedes editar incidentes específicos</span>
      {% elif user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Jefe de Flota' %}
        <span class="text-muted">Como jefe de flota, puedes gestionar el estado de los incidentes</span>
      {% elif user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Mecánico' %}
        <span class="text-muted">Como mecánico, puedes trabajar en las órdenes de trabajo generadas</span>
      {% else %}
        <span class="text-muted">Usuario: {{ user.username|default:'No autenticado' }} | Rol: {{ user.flotauser.role.name|default:'Sin FlotaUser' }}</span>
      {% endif %}
    </div>
    <p class="text-muted mb-0">Gestiona los incidentes reportados</p>
  </div>
  
  <!-- Mostrar mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  
  {% if user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Recepcionista de Vehículos' %}
    <form id="multiple-diagnostic-form" method="post" action="{% url 'incidents:create_multiple_diagnostic' %}">
      {% csrf_token %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <button type="submit" id="create-multiple-diagnostic-btn" class="btn btn-success" disabled>
            <i class="fas fa-plus"></i> Crear Diagnóstico Múltiple
          </button>
          <small class="text-muted ms-2">Selecciona uno o más incidentes para crear un diagnóstico conjunto</small>
        </div>
        <div>
          <button type="button" id="select-all-btn" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-check-square"></i> Seleccionar Todos
          </button>
          <button type="button" id="clear-selection-btn" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-square"></i> Limpiar Selección
          </button>
        </div>
      </div>
    {% endif %}

    <div id="incidents-container">
    {% for incident in incidents %}
    <div class="card incident-card">
      {% if user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Recepcionista de Vehículos' %}
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div class="form-check">
            <input class="form-check-input incident-checkbox" type="checkbox" name="selected_incidents" value="{{ incident.id_incident }}" id="incident-{{ incident.id_incident }}">
            <label class="form-check-label" for="incident-{{ incident.id_incident }}">
              <i class="fas fa-car"></i> <strong>{{ incident.vehicle.patent }}</strong>
            </label>
          </div>
          {% if incident.latest_diagnostic %}
          {% with latest_diagnostic=incident.latest_diagnostic.0 %}
          {% if latest_diagnostic.status == 'Reportada' %}
            <span class="badge bg-warning">Reportada</span>
          {% elif latest_diagnostic.status == 'En_revision' %}
            <span class="badge bg-info">En revisión</span>
          {% elif latest_diagnostic.status == 'Resuelta' %}
            <span class="badge bg-success">Resuelta</span>
          {% elif latest_diagnostic.status == 'Cerrada' %}
            <span class="badge bg-secondary">Cerrada</span>
          {% else %}
            <span class="badge bg-light">{{ latest_diagnostic.get_status_display|default:"Sin estado" }}</span>
          {% endif %}
          {% endwith %}
          {% else %}
            <span class="badge bg-warning">Reportada</span>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-car"></i> <strong>{{ incident.vehicle.patent }}</strong>
          </h6>
          {% if incident.latest_diagnostic %}
          {% with latest_diagnostic=incident.latest_diagnostic.0 %}
          {% if latest_diagnostic.status == 'Reportada' %}
            <span class="badge bg-warning">Reportada</span>
          {% elif latest_diagnostic.status == 'En_revision' %}
            <span class="badge bg-info">En revisión</span>
          {% elif latest_diagnostic.status == 'Resuelta' %}
            <span class="badge bg-success">Resuelta</span>
          {% elif latest_diagnostic.status == 'Cerrada' %}
            <span class="badge bg-secondary">Cerrada</span>
          {% else %}
            <span class="badge bg-light">{{ latest_diagnostic.get_status_display|default:"Sin estado" }}</span>
          {% endif %}
          {% endwith %}
          {% else %}
            <span class="badge bg-warning">Reportada</span>
          {% endif %}
        </div>
      </div>
      {% endif %}
        <div class="card-body">
          <div class="incident-info">
            <h5 class="card-title">{{ incident.name }}</h5>
            <div class="row">
              <div class="col-6">
                <p class="mb-1">
                  <strong>Tipo:</strong> {{ incident.get_incident_type_display }}
                </p>
                <p class="mb-1">
                  <strong>Prioridad:</strong>
                  <span class="badge bg-{% if incident.priority == 'Baja' %}light text-dark{% elif incident.priority == 'Normal' %}info{% elif incident.priority == 'Alta' %}warning{% else %}danger{% endif %}">
                    {{ incident.priority|default:"Sin prioridad" }}
                  </span>
                </p>
              </div>
              <div class="col-6">
                {% if incident.requires_tow %}
                <p class="mb-1">
                  <strong>🔧 Requiere remolque</strong>
                </p>
                {% endif %}
                {% if incident.is_emergency %}
                <p class="mb-1">
                  <strong>🚨 Es una emergencia</strong>
                </p>
                {% endif %}
                {% if incident.latest_diagnostic %}
                {% with latest_diagnostic=incident.latest_diagnostic.0 %}
                {% if latest_diagnostic.severity %}
                <p class="mb-1">
                  <strong>Severidad:</strong>
                  <span class="badge bg-{% if latest_diagnostic.severity == 'Baja' %}secondary{% elif latest_diagnostic.severity == 'Media' %}warning{% elif latest_diagnostic.severity == 'Alta' %}danger{% else %}dark{% endif %}">
                    {{ latest_diagnostic.severity }}
                  </span>
                </p>
                {% endif %}
                {% endwith %}
                {% endif %}
              </div>
            </div>
            <p class="mb-1">
              <strong>Reportado:</strong> {{ incident.reported_at|date:"d/m/Y H:i" }}
            </p>
            <p class="mb-1">
              <strong>Por:</strong> {{ incident.reported_by.name }} <span class="badge bg-primary">{{ incident.reported_by.role.name }}</span>
            </p>
            {% if incident.location %}
            <p class="mb-1">
              <strong>Ubicación:</strong> {{ incident.location }}
            </p>
            {% endif %}
            {% if incident.description %}
            <p class="mb-1 text-truncate" title="{{ incident.description }}">
              <strong>Descripción:</strong> {{ incident.description|truncatechars:50 }}
            </p>
            {% endif %}
          </div>

          <div class="card-actions mt-3{% if user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Vendedor' %} d-flex justify-content-center{% endif %}">
            <a href="{% url 'incidents:incident_detail' incident.id_incident %}" class="btn btn-primary btn-sm">
              <i class="fas fa-eye"></i> Ver Incidencia
            </a>
            {% if user.is_authenticated %}
              {% if user.flotauser %}
                {% if user.flotauser.role.name == 'Recepcionista de Vehículos' %}
                  <a href="{% url 'incidents:recepcionista_escalar_mecanica' incident.id_incident %}" class="btn btn-info btn-sm">
                    <i class="fas fa-wrench"></i> Escalar Mecánica In Situ
                  </a>
                {% elif user.flotauser.role.name == 'Supervisor' %}
                  <a href="{% url 'incidents:supervisor_edit_incident' incident.id_incident %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-edit"></i> Editar
                  </a>
                  {% if incident.status != 'Resuelta' and incident.status != 'Cerrada' %}
                    <button class="btn btn-success btn-sm" onclick="changeStatus({{ incident.id_incident }}, 'Resuelta')">
                      <i class="fas fa-check"></i> Resolver
                    </button>
                  {% endif %}
                {% elif user.flotauser.role.name == 'Jefe de Flota' %}
                  {% if incident.status == 'Reportada' %}
                    <button class="btn btn-info btn-sm" onclick="changeStatus({{ incident.id_incident }}, 'En_revision')">
                      <i class="fas fa-search"></i> Revisar
                    </button>
                  {% endif %}
                  <button class="btn btn-danger btn-sm" onclick="changeStatus({{ incident.id_incident }}, 'Cerrada')">
                    <i class="fas fa-times"></i> Cerrar
                  </button>
                {% elif user.flotauser.role.name == 'Mecánico' %}
                  <a href="#" class="btn btn-outline-info btn-sm" onclick="alert('Como mecánico, puedes trabajar en las OT asignadas')">
                    <i class="fas fa-wrench"></i> Ver OT
                  </a>
                {% elif user.flotauser.role.name == 'Vendedor' %}
                  <!-- Vendedor solo puede ver incidencias -->
                  <button class="btn btn-outline-secondary btn-sm" disabled>
                    <i class="fas fa-lock"></i> Solo lectura
                  </button>
                {% elif user.flotauser.role.name == 'Guardia' %}
                  <!-- Guardia solo puede ver incidencias, no editar -->
                {% else %}
                  <button class="btn btn-outline-secondary btn-sm" disabled title="Rol: {{ user.flotauser.role.name }}">
                    <i class="fas fa-edit"></i> Editar
                  </button>
                  <script>console.log('Rol no reconocido:', '{{ user.flotauser.role.name }}');</script>
                {% endif %}
              {% else %}
                <script>console.log('Usuario no tiene flotauser');</script>
              {% endif %}
            {% else %}
              <script>console.log('Usuario no autenticado');</script>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
    <div class="col-12">
      {% if user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Bodeguero' %}
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i> Como bodeguero, no tienes acceso al módulo de incidentes.
        </div>
      {% elif user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Vendedor' %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> No has reportado ningún incidente aún.
        </div>
      {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> No hay incidentes registrados.
        </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  {% if user.is_authenticated and user.flotauser and user.flotauser.role.name == 'Recepcionista de Vehículos' %}
    </form>
  {% endif %}
</div>
{% endblock %}
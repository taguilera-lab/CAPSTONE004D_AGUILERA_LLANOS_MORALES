{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle de Incidente #{{ incident.id_incident }}{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'incidents/css/incident_detail.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Botón de regreso -->
    <div class="back-btn">
        <a href="{% url 'incident_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Lista de Incidentes
        </a>
    </div>

    <!-- Header del incidente -->
    <div class="incident-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    Incidente #{{ incident.id_incident }}
                </h1>
                <h4 class="mb-3">{{ incident.name }}</h4>
                <div class="d-flex gap-2 flex-wrap">
                    <span class="incident-badge status-{{ incident.status|lower|cut:'_' }}">
                        <i class="fas fa-info-circle"></i> {{ incident.get_status_display }}
                    </span>
                    {% if incident.diagnostics.severity %}
                    <span class="incident-badge severity-{{ incident.diagnostics.severity|lower }}">
                        <i class="fas fa-exclamation-circle"></i> {{ incident.diagnostics.severity }}
                    </span>
                    {% endif %}
                    {% if incident.priority %}
                    <span class="incident-badge priority-{{ incident.priority|lower }}">
                        <i class="fas fa-flag"></i> {{ incident.priority }}
                    </span>
                    {% endif %}
                    {% if incident.is_emergency %}
                    <span class="incident-badge bg-danger">
                        <i class="fas fa-siren"></i> Emergencia
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="badge-patent fs-4">{{ incident.vehicle.patent }}</div>
                <small class="text-white-50">Vehículo afectado</small>
            </div>
        </div>
    </div>

            <!-- Mensajes y Alertas -->
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        <!-- Información General -->
        <div class="col-lg-8">
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-info-circle"></i> Información General
                    </h5>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <span class="detail-label">Tipo de Incidente:</span>
                        <span class="detail-value">{{ incident.get_incident_type_display }}</span>
                    </div>
                    {% if incident.diagnostics.category %}
                    <div class="detail-row">
                        <span class="detail-label">Categoría:</span>
                        <span class="detail-value">{{ incident.diagnostics.get_category_display }}</span>
                    </div>
                    {% endif %}
                    <div class="detail-row">
                        <span class="detail-label">Reportado por:</span>
                        <span class="detail-value">{{ incident.reported_by.name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fecha de Reporte:</span>
                        <span class="detail-value">{{ incident.reported_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if incident.diagnostics.assigned_to %}
                    <div class="detail-row">
                        <span class="detail-label">Asignado a:</span>
                        <span class="detail-value">{{ incident.diagnostics.assigned_to.name }}</span>
                    </div>
                    {% endif %}
                    {% if incident.diagnostics.resolved_at %}
                    <div class="detail-row">
                        <span class="detail-label">Fecha de Resolución:</span>
                        <span class="detail-value">{{ incident.diagnostics.resolved_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Descripción y Detalles -->
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-file-alt"></i> Descripción y Detalles
                    </h5>
                </div>
                <div class="card-body">
                    {% if incident.description %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Descripción:</h6>
                        <p class="mb-3">{{ incident.description }}</p>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Descripción:</h6>
                        <p class="text-muted mb-3"><em>Sin descripción disponible</em></p>
                    </div>
                    {% endif %}

                    {% if incident.diagnostics.symptoms %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Síntomas:</h6>
                        <p class="mb-3">{{ incident.diagnostics.symptoms }}</p>
                    </div>
                    {% endif %}

                    {% if incident.diagnostics.possible_cause %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Causa Posible:</h6>
                        <p class="mb-3">{{ incident.diagnostics.possible_cause }}</p>
                    </div>
                    {% endif %}

                    {% if incident.location %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Ubicación:</h6>
                        <p class="mb-3">{{ incident.location }}</p>
                    </div>
                    {% endif %}

                    {% if incident.diagnostics.resolution_notes %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Notas de Resolución:</h6>
                        <p class="mb-3">{{ incident.diagnostics.resolution_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Timeline -->
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-clock"></i> Timeline del Incidente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <h6>Reportado</h6>
                            <p class="text-muted mb-0">{{ incident.reported_at|date:"d/m/Y H:i" }}</p>
                            <small class="text-muted">Por: {{ incident.reported_by.name }}</small>
                        </div>

                        {% if incident.status != 'Reportada' %}
                        <div class="timeline-item">
                            <h6>Estado Actual: {{ incident.get_status_display }}</h6>
                            <p class="text-muted mb-0">{{ incident.updated_at|date:"d/m/Y H:i" }}</p>
                        </div>
                        {% endif %}

                        {% if incident.resolved_at %}
                        <div class="timeline-item">
                            <h6>Resuelto</h6>
                            <p class="text-muted mb-0">{{ incident.resolved_at|date:"d/m/Y H:i" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Información del Conductor -->
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-user"></i> Información del Conductor
                    </h5>
                </div>
                <div class="card-body">
                    {% if incident.reported_by.role.name == "Vendedor" %}
                    <div class="text-center mb-3">
                        <div class="driver-avatar">
                            <i class="fas fa-user-circle fa-3x text-muted"></i>
                        </div>
                        <h6 class="mt-2">{{ incident.reported_by.name }}</h6>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value">{{ incident.reported_by.name }}</span>
                    </div>
                    {% if incident.reported_by.patent %}
                    <div class="detail-row">
                        <span class="detail-label">Vehículo asignado:</span>
                        <span class="detail-value">{{ incident.reported_by.patent.patent }}</span>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-user-slash fa-2x mb-2"></i>
                        <p>No hay conductor asignado</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <!-- Información del Vehículo -->
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-car"></i> Información del Vehículo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="badge-patent fs-3">{{ incident.vehicle.patent }}</div>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Marca:</span>
                        <span class="detail-value">{{ incident.vehicle.brand }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Modelo:</span>
                        <span class="detail-value">{{ incident.vehicle.model }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Año:</span>
                        <span class="detail-value">{{ incident.vehicle.year }}</span>
                    </div>
                    {% if incident.vehicle.mileage %}
                    <div class="detail-row">
                        <span class="detail-label">Kilometraje:</span>
                        <span class="detail-value">{{ incident.vehicle.mileage|floatformat:0 }} km</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Características del Incidente -->
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-cogs"></i> Características
                    </h5>
                </div>
                <div class="card-body">
                    {% if incident.requires_tow %}
                    <div class="mb-2">
                        <i class="fas fa-check-circle text-success"></i>
                        Requiere remolque
                    </div>
                    {% endif %}
                    {% if incident.diagnostics.affects_operation %}
                    <div class="mb-2">
                        <i class="fas fa-check-circle text-warning"></i>
                        Afecta operaciones
                    </div>
                    {% endif %}
                    {% if incident.diagnostics.follow_up_required %}
                    <div class="mb-2">
                        <i class="fas fa-check-circle text-info"></i>
                        Seguimiento requerido
                    </div>
                    {% endif %}
                    {% if incident.is_emergency %}
                    <div class="mb-2">
                        <i class="fas fa-siren text-danger"></i>
                        Emergencia
                    </div>
                    {% endif %}
                    {% if not incident.requires_tow and not incident.diagnostics.affects_operation and not incident.diagnostics.follow_up_required and not incident.is_emergency %}
                    <div class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        No hay características especiales registradas
                    </div>
                    {% endif %}
                    {% if incident.diagnostics.estimated_resolution_time %}
                    <div class="mt-3">
                        <strong>Tiempo estimado de resolución:</strong><br>
                        {{ incident.diagnostics.estimated_resolution_time }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Ubicación -->
            {% if incident.latitude and incident.longitude %}
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-map-marker-alt"></i> Ubicación del Incidente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="map-container" id="incident-map">
                        <!-- Aquí iría un mapa si tuviéramos la API de Google Maps o similar -->
                        <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                            <div class="text-center">
                                <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-1">Coordenadas GPS</p>
                                <small class="text-muted">
                                    Lat: {{ incident.latitude }}<br>
                                    Lng: {{ incident.longitude }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Imágenes -->
            {% if incident.images.all %}
            <div class="card info-card mb-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-images"></i> Imágenes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        {% for image in incident.images.all %}
                        <div class="col-6">
                            <img src="{{ image.image.url }}" alt="{{ image.name }}" class="img-fluid rounded">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Acciones según rol -->
            {% if user.is_authenticated and user.flotauser %}
            <div class="card info-card">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-tools"></i> Acciones Disponibles
                    </h5>
                </div>
                <div class="card-body">
                    {% if user.flotauser.role.name == 'Supervisor' %}
                        {% if incident.status != 'Resuelta' and incident.status != 'Cerrada' %}
                        <a href="{% url 'supervisor_edit_incident' incident.id_incident %}" class="btn btn-outline-primary btn-sm w-100 mb-2">
                            <i class="fas fa-edit"></i> Editar Incidente
                        </a>
                        <button class="btn btn-success btn-sm w-100 mb-2" onclick="changeStatus({{ incident.id_incident }}, 'Resuelta')">
                            <i class="fas fa-check"></i> Marcar como Resuelta
                        </button>
                        {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i> Este incidente ya está {{ incident.get_status_display|lower }}
                        </div>
                        {% endif %}
                    {% elif user.flotauser.role.name == 'Jefe de Flota' %}
                        {% if incident.status == 'Reportada' %}
                        <button class="btn btn-info btn-sm w-100 mb-2" onclick="changeStatus({{ incident.id_incident }}, 'En_revision')">
                            <i class="fas fa-search"></i> Enviar a Revisión
                        </button>
                        {% endif %}
                        <button class="btn btn-danger btn-sm w-100" onclick="changeStatus({{ incident.id_incident }}, 'Cerrada')">
                            <i class="fas fa-times"></i> Cerrar Incidente
                        </button>
                    {% elif user.flotauser.role.name == 'Recepcionista de Vehículos' %}
                        <a href="{% url 'recepcionista_generate_ot' incident.id_incident %}" class="btn btn-warning btn-sm w-100">
                            <i class="fas fa-tools"></i> Generar Orden de Trabajo
                        </a>
                    {% else %}
                        <div class="alert alert-secondary mb-0">
                            <i class="fas fa-user"></i> Como {{ user.flotauser.role.name }}, no tienes acciones disponibles para este incidente.
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Resumen y Estadísticas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card info-card">
                <div class="card-header bg-light border-bottom">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-chart-bar"></i> Resumen del Incidente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                                <h4 class="mb-1">{{ incident.reported_at|date:"d/m/Y" }}</h4>
                                <small class="text-muted">Fecha de Reporte</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                <h4 class="mb-1">{{ incident.reported_at|timesince }}</h4>
                                <small class="text-muted">Tiempo Transcurrido</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-user fa-2x text-success mb-2"></i>
                                <h4 class="mb-1">{{ incident.reported_by.name }}</h4>
                                <small class="text-muted">Reportado por</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-car fa-2x text-warning mb-2"></i>
                                <h4 class="mb-1">{{ incident.vehicle.patent }}</h4>
                                <small class="text-muted">Vehículo Afectado</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para cambiar el estado del incidente
function changeStatus(incidentId, newStatus) {
    const statusMessages = {
        'Resuelta': '¿Estás seguro de marcar este incidente como RESUELTO?',
        'En_revision': '¿Estás seguro de enviar este incidente a REVISIÓN?',
        'Cerrada': '¿Estás seguro de CERRAR este incidente? Esta acción es irreversible.'
    };

    const message = statusMessages[newStatus] || `¿Estás seguro de cambiar el status del incidente a "${newStatus}"?`;

    if (confirm(message)) {
        // Mostrar indicador de carga
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        button.disabled = true;

        // Simular procesamiento (aquí iría la llamada AJAX real)
        setTimeout(() => {
            // Aquí iría la lógica real para cambiar el status via AJAX
            alert(`Funcionalidad próximamente disponible.\n\nIncidente: #${incidentId}\nNuevo estado: ${newStatus}`);

            // Restaurar botón
            button.innerHTML = originalText;
            button.disabled = false;

            // Recargar la página para mostrar cambios
            window.location.reload();
        }, 1000);
    }
}

// Función para mostrar/ocultar secciones adicionales
document.addEventListener('DOMContentLoaded', function() {
    // Agregar animaciones sutiles a las tarjetas
    const cards = document.querySelectorAll('.info-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });

    // Mejorar la experiencia de los botones
    const actionButtons = document.querySelectorAll('.btn');
    actionButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
        });

        button.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    console.log('Detalle de incidente cargado completamente');
});
</script>
{% endblock %}
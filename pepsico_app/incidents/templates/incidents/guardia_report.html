{% extends 'base.html' %}
{% load static %}

{% block title %}Reportar Incidente - Guardia{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'incidents/css/guardia_report.css' %}">
<style>
.camera-container {
    margin: 1rem 0;
    padding: 1rem;
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    text-align: center;
}

.camera-preview {
    display: none;
    margin: 1rem auto;
    max-width: 100%;
    border-radius: 0.5rem;
}

.camera-controls {
    margin-top: 1rem;
}

.btn-camera {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    cursor: pointer;
    margin: 0.25rem;
}

.btn-camera:hover {
    background-color: #218838;
}

.btn-capture {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    cursor: pointer;
    margin: 0.25rem;
}

.btn-capture:hover {
    background-color: #c82333;
}

.captured-images {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
}

.image-preview {
    position: relative;
    display: inline-block;
}

.image-preview img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 0.25rem;
    border: 2px solid #dee2e6;
}

.remove-image {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="contenedor">
    <div class="formulario">
        <h2>Reportar Incidente (Guardia)</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}

            <!-- Sección de imágenes -->
            <div class="form-group">
                <label>Imágenes del incidente (opcional):</label>

                <!-- Contenedor de cámara -->
                <div class="camera-container">
                    <video id="camera-preview" class="camera-preview" autoplay playsinline></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>

                    <div class="camera-controls">
                        <button type="button" id="start-camera" class="btn-camera">
                            <i class="fas fa-camera"></i> Activar Cámara
                        </button>
                        <button type="button" id="capture-photo" class="btn-capture" style="display: none;">
                            <i class="fas fa-camera-retro"></i> Tomar Foto
                        </button>
                        <button type="button" id="stop-camera" class="btn-camera" style="display: none;">
                            <i class="fas fa-stop"></i> Detener Cámara
                        </button>
                    </div>

                    <div class="captured-images" id="captured-images"></div>
                </div>

                <!-- Campo oculto para las imágenes capturadas -->
                <input type="file" name="camera_images" id="camera-images-input" multiple style="display: none;" accept="image/*">

                <small class="form-text text-muted">
                    Use la cámara para tomar fotos del incidente. Las imágenes se subirán automáticamente.
                </small>
            </div>

            <div class="botones">
                <button type="submit" class="btn-programar">Reportar</button>
            </div>
        </form>
    </div>
</div>

<script>
let cameraStream = null;
let capturedImages = [];

const cameraPreview = document.getElementById('camera-preview');
const cameraCanvas = document.getElementById('camera-canvas');
const startCameraBtn = document.getElementById('start-camera');
const capturePhotoBtn = document.getElementById('capture-photo');
const stopCameraBtn = document.getElementById('stop-camera');
const capturedImagesContainer = document.getElementById('captured-images');
const cameraImagesInput = document.getElementById('camera-images-input');

// Función para iniciar la cámara
async function startCamera() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }, // Cámara trasera si está disponible
            audio: false
        });

        cameraPreview.srcObject = cameraStream;
        cameraPreview.style.display = 'block';
        startCameraBtn.style.display = 'none';
        capturePhotoBtn.style.display = 'inline-block';
        stopCameraBtn.style.display = 'inline-block';

    } catch (error) {
        console.error('Error al acceder a la cámara:', error);
        alert('No se pudo acceder a la cámara. Verifique los permisos.');
    }
}

// Función para detener la cámara
function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }

    cameraPreview.style.display = 'none';
    cameraPreview.srcObject = null;
    startCameraBtn.style.display = 'inline-block';
    capturePhotoBtn.style.display = 'none';
    stopCameraBtn.style.display = 'none';
}

// Función para capturar foto
function capturePhoto() {
    const context = cameraCanvas.getContext('2d');
    cameraCanvas.width = cameraPreview.videoWidth;
    cameraCanvas.height = cameraPreview.videoHeight;
    context.drawImage(cameraPreview, 0, 0);

    // Convertir canvas a blob y crear un archivo
    cameraCanvas.toBlob((blob) => {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const fileName = `foto_${timestamp}.jpg`;
        const file = new File([blob], fileName, { type: 'image/jpeg' });

        const imageData = {
            id: Date.now(),
            file: file,
            url: URL.createObjectURL(blob)
        };

        capturedImages.push(imageData);
        updateCapturedImagesDisplay();
        updateFormData();
    }, 'image/jpeg', 0.8);
}

// Función para actualizar la visualización de imágenes capturadas
function updateCapturedImagesDisplay() {
    capturedImagesContainer.innerHTML = '';

    capturedImages.forEach((image, index) => {
        const imageDiv = document.createElement('div');
        imageDiv.className = 'image-preview';

        const img = document.createElement('img');
        img.src = image.url;
        img.alt = `Foto ${index + 1}`;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = () => removeImage(index);

        imageDiv.appendChild(img);
        imageDiv.appendChild(removeBtn);
        capturedImagesContainer.appendChild(imageDiv);
    });
}

// Función para remover imagen
function removeImage(index) {
    URL.revokeObjectURL(capturedImages[index].url);
    capturedImages.splice(index, 1);
    updateCapturedImagesDisplay();
    updateFormData();
}

// Función para actualizar los datos del formulario
function updateFormData() {
    // Crear un DataTransfer para agregar los archivos al input
    const dt = new DataTransfer();

    capturedImages.forEach((image, index) => {
        // Mantener el archivo original
        dt.items.add(image.file);
    });

    // Asignar los archivos al input
    cameraImagesInput.files = dt.files;
}

// Event listeners
startCameraBtn.addEventListener('click', startCamera);
capturePhotoBtn.addEventListener('click', capturePhoto);
stopCameraBtn.addEventListener('click', stopCamera);

// Limpiar recursos cuando se cierra la página
window.addEventListener('beforeunload', () => {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
    capturedImages.forEach(img => URL.revokeObjectURL(img.url));
});
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle de Diagnóstico #{{ diagnostic.id }}{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'diagnostics/css/diagnostics_detail.css' %}">
<script src="{% static 'diagnostics/js/diagnostics_detail.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="mb-0">
            <i class="fas fa-stethoscope text-primary"></i> Diagnóstico #{{ diagnostic.id }}
          </h1>
          {% if diagnostic.incident %}
            <p class="mb-0 text-muted">
              Relacionado con Incidente #{{ diagnostic.incident.id_incident }}
            </p>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          {% if user.flotauser.role.name in 'Supervisor,Jefe de Flota' or diagnostic.assigned_to == user.flotauser %}
            <a href="{% url 'diagnostics:diagnostics_update' diagnostic.id %}" class="btn btn-primary">
              <i class="fas fa-edit"></i> Editar
            </a>
          {% endif %}
          <a href="{% url 'diagnostics:diagnostics_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
          </a>
        </div>
      </div>

      <!-- Mostrar mensajes -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Información del diagnóstico -->
      <div class="row">
        <div class="col-lg-8">
          <!-- Estado y Severidad -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-info-circle"></i> Información General
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong>Estado:</strong>
                    <span class="badge bg-{% if diagnostic.status == 'Resuelta' %}success{% elif diagnostic.status == 'Diagnostico_In_Situ' %}warning{% elif diagnostic.status == 'OT_Generada' %}info{% else %}secondary{% endif %} ms-2">
                      {{ diagnostic.get_status_display }}
                    </span>
                  </p>
                  <p class="mb-2">
                    <strong>Severidad:</strong>
                    <span class="badge bg-{% if diagnostic.severity == 'Critica' %}danger{% elif diagnostic.severity == 'Alta' %}warning{% elif diagnostic.severity == 'Media' %}info{% else %}secondary{% endif %} ms-2">
                      {{ diagnostic.get_severity_display|default:"No especificada" }}
                    </span>
                  </p>
                  <p class="mb-2">
                    <strong>Categoría:</strong> {{ diagnostic.get_category_display|default:"No especificada" }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong>Asignado a:</strong>
                    {% if diagnostic.assigned_to %}
                      {{ diagnostic.assigned_to.name }}
                    {% else %}
                      <span class="text-muted">No asignado</span>
                    {% endif %}
                  </p>
                  <p class="mb-2">
                    <strong>Creado por:</strong>
                    {% if diagnostic.diagnostics_created_by %}
                      {{ diagnostic.diagnostics_created_by.name }}
                    {% else %}
                      <span class="text-muted">Desconocido</span>
                    {% endif %}
                  </p>
                  <p class="mb-2">
                    <strong>Fecha de creación:</strong> {{ diagnostic.diagnostics_created_at|date:"d/m/Y H:i" }}
                  </p>
                  {% if diagnostic.diagnostics_updated_at and diagnostic.diagnostics_updated_at != diagnostic.diagnostics_created_at %}
                    <p class="mb-2">
                      <strong>Última actualización:</strong> {{ diagnostic.diagnostics_updated_at|date:"d/m/Y H:i" }}
                    </p>
                  {% endif %}
                </div>
              </div>

              {% if diagnostic.affects_operation or diagnostic.follow_up_required %}
              <div class="mt-3">
                {% if diagnostic.affects_operation %}
                  <span class="badge bg-danger me-2">Afecta Operaciones</span>
                {% endif %}
                {% if diagnostic.follow_up_required %}
                  <span class="badge bg-warning">Requiere Seguimiento</span>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Detalles del diagnóstico -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-search"></i> Detalles del Diagnóstico
              </h5>
            </div>
            <div class="card-body">
              {% if diagnostic.symptoms %}
                <div class="mb-3">
                  <h6>Síntomas reportados:</h6>
                  <p class="text-muted">{{ diagnostic.symptoms }}</p>
                </div>
              {% endif %}

              {% if diagnostic.possible_cause %}
                <div class="mb-3">
                  <h6>Causa posible:</h6>
                  <p class="text-muted">{{ diagnostic.possible_cause }}</p>
                </div>
              {% endif %}

              {% if diagnostic.diagnostic_details %}
                <div class="mb-3">
                  <h6>Detalles del diagnóstico:</h6>
                  <p class="text-muted">{{ diagnostic.diagnostic_details }}</p>
                </div>
              {% endif %}

              {% if diagnostic.recommended_actions %}
                <div class="mb-3">
                  <h6>Acciones recomendadas:</h6>
                  <p class="text-muted">{{ diagnostic.recommended_actions }}</p>
                </div>
              {% endif %}

              {% if diagnostic.estimated_resolution_time %}
                <div class="mb-3">
                  <h6>Tiempo estimado de resolución:</h6>
                  <p class="text-muted">{{ diagnostic.estimated_resolution_time }}</p>
                </div>
              {% endif %}

              {% if diagnostic.resolution_notes %}
                <div class="mb-3">
                  <h6>Notas de resolución:</h6>
                  <p class="text-muted">{{ diagnostic.resolution_notes }}</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Información del vehículo -->
          {% if diagnostic.incident %}
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-truck"></i> Información del Vehículo
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong>Patente:</strong> {{ diagnostic.incident.vehicle.patent }}
                  </p>
                  <p class="mb-2">
                    <strong>Marca:</strong> {{ diagnostic.incident.vehicle.brand }}
                  </p>
                  <p class="mb-2">
                    <strong>Modelo:</strong> {{ diagnostic.incident.vehicle.model }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong>Año:</strong> {{ diagnostic.incident.vehicle.year|default:"No especificado" }}
                  </p>
                  <p class="mb-2">
                    <strong>Kilometraje:</strong> {{ diagnostic.incident.vehicle.mileage|default:"No especificado" }}
                  </p>
                  <p class="mb-2">
                    <strong>Estado:</strong> {{ diagnostic.incident.vehicle.get_status_display|default:"No especificado" }}
                  </p>
                </div>
              </div>
              <div class="mt-3">
                <a href="{% url 'documents_incident_detail' diagnostic.incident.id %}" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-external-link-alt"></i> Ver Incidente Completo
                </a>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Panel lateral -->
        <div class="col-lg-4">
          <!-- Acciones rápidas -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-bolt"></i> Acciones Rápidas
              </h5>
            </div>
            <div class="card-body">
              {% if user.flotauser.role.name in 'Supervisor,Jefe de Flota' or diagnostic.assigned_to == user.flotauser %}
                {% if diagnostic.status != 'Resuelta' %}
                  <button class="btn btn-success btn-sm w-100 mb-2" onclick="markAsResolved({{ diagnostic.id }})">
                    <i class="fas fa-check"></i> Marcar como Resuelta
                  </button>
                {% endif %}

                {% if diagnostic.status == 'Diagnostico_In_Situ' %}
                  <button class="btn btn-info btn-sm w-100 mb-2" onclick="generateWorkOrder({{ diagnostic.id }})">
                    <i class="fas fa-tools"></i> Generar Orden de Trabajo
                  </button>
                {% endif %}
              {% endif %}

              <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="printDiagnostic()">
                <i class="fas fa-print"></i> Imprimir
              </button>

              {% if user.flotauser.role.name in 'Supervisor,Jefe de Flota' %}
                <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteDiagnostic({{ diagnostic.id }})">
                  <i class="fas fa-trash"></i> Eliminar
                </button>
              {% endif %}
            </div>
          </div>

          <!-- Historial de cambios -->
          {% if diagnostic.updated_at and diagnostic.updated_at != diagnostic.created_at %}
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-history"></i> Historial
              </h5>
            </div>
            <div class="card-body">
              <div class="timeline">
                <div class="timeline-item">
                  <div class="timeline-marker bg-primary"></div>
                  <div class="timeline-content">
                    <h6 class="mb-1">Creado</h6>
                    <small class="text-muted">{{ diagnostic.created_at|date:"d/m/Y H:i" }} por {{ diagnostic.created_by.name }}</small>
                  </div>
                </div>
                {% if diagnostic.updated_at != diagnostic.created_at %}
                <div class="timeline-item">
                  <div class="timeline-marker bg-warning"></div>
                  <div class="timeline-content">
                    <h6 class="mb-1">Última actualización</h6>
                    <small class="text-muted">{{ diagnostic.updated_at|date:"d/m/Y H:i" }}</small>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Estadísticas -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar"></i> Estadísticas
              </h5>
            </div>
            <div class="card-body">
              <div class="stat-item">
                <span class="stat-label">Tiempo transcurrido:</span>
                <span class="stat-value">{{ diagnostic.created_at|timesince }}</span>
              </div>
              {% if diagnostic.estimated_resolution_time %}
              <div class="stat-item">
                <span class="stat-label">Tiempo estimado:</span>
                <span class="stat-value">{{ diagnostic.estimated_resolution_time }}</span>
              </div>
              {% endif %}
              <div class="stat-item">
                <span class="stat-label">Estado actual:</span>
                <span class="stat-value badge bg-{% if diagnostic.status == 'Resuelta' %}success{% elif diagnostic.status == 'Diagnostico_In_Situ' %}warning{% elif diagnostic.status == 'OT_Generada' %}info{% else %}secondary{% endif %}">{{ diagnostic.get_status_display }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Está seguro de que desea eliminar este diagnóstico? Esta acción no se puede deshacer.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% extends 'base.html' %}
{% load static %}
{% block title %}Documentos y Reportes{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <h1 class="mb-3 mb-md-0">
          <i class="fas fa-chart-line"></i> Subida de Documentos - Generación de Reportes
        </h1>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-3 mb-3 mb-md-0">
      <div class="card bg-primary text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Total reportes</p>
              <h2 class="mb-0">{{ total_reports }}</h2>
            </div>
            <i class="fas fa-layer-group fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
      <div class="card bg-success text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Generados hoy</p>
              <h2 class="mb-0">{{ reports_today }}</h2>
            </div>
            <i class="fas fa-calendar-day fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
      <div class="card bg-warning text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Últimos 7 días</p>
              <h2 class="mb-0">{{ reports_last_week }}</h2>
            </div>
            <i class="fas fa-history fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-dark text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Tipos activos</p>
              <h2 class="mb-0">{{ report_types_count }}</h2>
            </div>
              <i class="fas fa-tags fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accesos Rápidos -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-bolt"></i> Accesos rápidos
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <a href="{% url 'document_upload:document_list' %}" class="btn btn-outline-info w-100">
                <i class="fas fa-file-alt"></i> Ver documentos
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'document_upload:upload' %}" class="btn btn-outline-success w-100">
                <i class="fas fa-upload"></i> Subir documento
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'datos' %}#tabla-reports" class="btn btn-outline-primary w-100">
                <i class="fas fa-list"></i> Ver reportes
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'create_form' %}#form-report" class="btn btn-outline-warning w-100">
                <i class="fas fa-file-signature"></i> Generar reporte
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'document_upload:document_type_list' %}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-tags"></i> Gestionar tipos de documento
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'document_upload:report_type_list' %}" class="btn btn-outline-primary w-100">
                <i class="fas fa-file-signature"></i> Gestionar tipos de reporte
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'incidents:incident_list' %}" class="btn btn-outline-danger w-100">
                <i class="fas fa-exclamation-circle"></i> Incidentes
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'diagnostics:diagnostics_list' %}" class="btn btn-outline-dark w-100">
                <i class="fas fa-stethoscope"></i> Diagnósticos
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'calendario' %}" class="btn btn-outline-light w-100">
                <i class="fas fa-calendar"></i> Agenda
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tarjetas de Documentos -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3 mb-md-0">
      <div class="card bg-info text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Total documentos</p>
              <h2 class="mb-0">{{ total_documents }}</h2>
            </div>
            <i class="fas fa-file-upload fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Subidos hoy</p>
              <h2 class="mb-0">{{ documents_today }}</h2>
            </div>
            <i class="fas fa-calendar-day fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
      <div class="card bg-warning text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Últimos 7 días</p>
              <h2 class="mb-0">{{ documents_last_week }}</h2>
            </div>
            <i class="fas fa-history fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-uppercase mb-1 small">Almacenamiento</p>
              <h4 class="mb-0">{{ total_file_size|filesizeformat }}</h4>
            </div>
            <i class="fas fa-hdd fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-chart-pie"></i> Reportes por tipo
          </h5>
          <span class="badge bg-secondary">{{ reports_by_type|length }} / {{ report_types_count }}</span>
        </div>
        <div class="card-body">
          {% if reports_by_type %}
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th class="text-end">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {% for report_type in reports_by_type %}
                <tr>
                  <td>{{ report_type.type_name|default:"Sin tipo" }}</td>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ report_type.count }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">Aún no hay datos para mostrar.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-wave-square"></i> Tendencia semanal
          </h5>
        </div>
        <div class="card-body">
          {% if daily_activity %}
            {% for day in daily_activity %}
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>{{ day.date|date:"d M" }}</span>
                <strong>{{ day.count }}</strong>
              </div>
              <div class="progress" style="height: 6px;">
                <div
                  class="progress-bar bg-info"
                  role="progressbar"
                  aria-valuemin="0"
                  aria-valuemax="{{ max_daily_activity }}"
                  aria-valuenow="{{ day.count }}">
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
          <p class="text-muted mb-0">Sin actividad registrada en los últimos días.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-user-tie"></i> Usuarios más activos
          </h5>
          <span class="badge bg-dark">Usuarios con reportes: {{ active_users }}</span>
        </div>
        <div class="card-body">
          {% if top_report_users %}
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Rol</th>
                  <th class="text-end">Reportes</th>
                </tr>
              </thead>
              <tbody>
                {% for user in top_report_users %}
                <tr>
                  <td>{{ user.user__name|default:"Sin nombre" }}</td>
                  <td>{{ user.user__role__name|default:"Sin rol" }}</td>
                  <td class="text-end">
                    <span class="badge bg-success">{{ user.count }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">Aún no hay usuarios con reportes registrados.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-clipboard-list"></i> Reportes recientes
          </h5>
        </div>
        <div class="card-body">
          {% if recent_reports %}
          <div class="list-group list-group-flush">
            {% for report in recent_reports %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="mb-1">Reporte #{{ report.id_report }} - {{ report.type }}</h6>
                  <small class="text-muted">
                    {{ report.user.name|default:"Sin usuario" }}
                    {% if report.user.role %} · {{ report.user.role.name }} {% endif %}
                  </small>
                </div>
                <small class="text-muted">{{ report.generated_datetime|date:"d/m/Y H:i" }}</small>
              </div>
              <p class="mb-0 text-muted">{{ report.data|truncatechars:100 }}</p>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">Sin reportes recientes para mostrar.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de Documentos -->
  <div class="row mb-4">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-file-alt"></i> Documentos por tipo
          </h5>
          <span class="badge bg-info">{{ documents_by_type|length }} tipos</span>
        </div>
        <div class="card-body">
          {% if documents_by_type %}
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th class="text-end">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {% for doc_type in documents_by_type %}
                <tr>
                  <td>{{ doc_type.type_name|default:"Sin tipo" }}</td>
                  <td class="text-end">
                    <span class="badge bg-info">{{ doc_type.count }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">Aún no hay documentos para mostrar.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-chart-line"></i> Tendencia semanal (Documentos)
          </h5>
        </div>
        <div class="card-body">
          {% if documents_daily_activity %}
            {% for day in documents_daily_activity %}
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>{{ day.date|date:"d M" }}</span>
                <strong>{{ day.count }}</strong>
              </div>
              <div class="progress" style="height: 6px;">
                <div
                  class="progress-bar bg-success"
                  role="progressbar"
                  aria-valuemin="0"
                  aria-valuemax="{{ max_documents_daily }}"
                  aria-valuenow="{{ day.count }}">
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
          <p class="text-muted mb-0">Sin actividad de subida en los últimos días.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-user-upload"></i> Usuarios más activos (Subidas)
          </h5>
          <span class="badge bg-info">Usuarios activos: {{ active_users_uploads }}</span>
        </div>
        <div class="card-body">
          {% if top_upload_users %}
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Rol</th>
                  <th class="text-end">Documentos</th>
                </tr>
              </thead>
              <tbody>
                {% for user in top_upload_users %}
                <tr>
                  <td>{{ user.user__name|default:"Sin nombre" }}</td>
                  <td>{{ user.user__role|default:"Sin rol" }}</td>
                  <td class="text-end">
                    <span class="badge bg-info">{{ user.count }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">Aún no hay usuarios con subidas registradas.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-file-upload"></i> Documentos recientes
          </h5>
        </div>
        <div class="card-body">
          {% if recent_documents %}
          <div class="list-group list-group-flush">
            {% for doc in recent_documents %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="mb-1">{{ doc.file_name }}</h6>
                  <small class="text-muted">
                    {{ doc.uploaded_by.first_name }} {{ doc.uploaded_by.last_name }}
                    {% if doc.document_type %} · {{ doc.document_type.name }} {% endif %}
                  </small>
                </div>
                <small class="text-muted">{{ doc.uploaded_at|date:"d/m/Y H:i" }}</small>
              </div>
              <p class="mb-0 text-muted">Tamaño: {{ doc.file_size|filesizeformat }}</p>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">Sin documentos recientes para mostrar.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-bolt"></i> Accesos rápidos
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <a href="{% url 'document_upload:document_list' %}" class="btn btn-outline-info w-100">
                <i class="fas fa-file-alt"></i> Ver documentos
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'document_upload:upload' %}" class="btn btn-outline-success w-100">
                <i class="fas fa-upload"></i> Subir documento
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'datos' %}#tabla-reports" class="btn btn-outline-primary w-100">
                <i class="fas fa-list"></i> Ver reportes
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'create_form' %}#form-report" class="btn btn-outline-warning w-100">
                <i class="fas fa-file-signature"></i> Generar reporte
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'document_upload:document_type_list' %}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-tags"></i> Gestionar tipos de documento
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'document_upload:report_type_list' %}" class="btn btn-outline-primary w-100">
                <i class="fas fa-file-signature"></i> Gestionar tipos de reporte
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'incidents:incident_list' %}" class="btn btn-outline-danger w-100">
                <i class="fas fa-exclamation-circle"></i> Incidentes
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'diagnostics:diagnostics_list' %}" class="btn btn-outline-dark w-100">
                <i class="fas fa-stethoscope"></i> Diagnósticos
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'calendario' %}" class="btn btn-outline-light w-100">
                <i class="fas fa-calendar"></i> Agenda
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Orden de Compra {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
          <i class="fas fa-shopping-cart"></i> Orden de Compra {{ order.order_number }}
        </h1>
        <div>
          {% if order.status == 'DRAFT' %}
          <a href="{% url 'repuestos:purchase_order_update' order.pk %}" class="btn btn-primary me-2">
            <i class="fas fa-edit"></i> Editar Orden
          </a>
          <small class="text-muted d-block">Solo se puede editar información básica (proveedor, fechas, notas)</small>
          {% else %}
          <small class="text-muted d-block">La orden no se puede editar porque ya fue procesada</small>
          {% endif %}
          <button type="button" class="btn btn-secondary me-2" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir
          </button>
          <a href="{% url 'repuestos:purchase_order_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Información de la Orden -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle"></i> Información de la Orden
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <strong>Número de Orden:</strong>
                <span class="ms-2">{{ order.order_number }}</span>
              </div>

              <div class="mb-3">
                <strong>Proveedor:</strong>
                <span class="ms-2">{{ order.supplier.name }}</span>
              </div>

              <div class="mb-3">
                <strong>Estado:</strong>
                <span class="ms-2">
                  {% if order.status == 'DRAFT' %}
                  <span class="badge bg-secondary">Borrador</span>
                  {% elif order.status == 'PENDING' %}
                  <span class="badge bg-primary">Pendiente</span>
                  {% elif order.status == 'APPROVED' %}
                  <span class="badge bg-success">Aprobada</span>
                  {% elif order.status == 'ORDERED' %}
                  <span class="badge bg-warning">Ordenada</span>
                  {% elif order.status == 'RECEIVED' %}
                  <span class="badge bg-info">Recibida</span>
                  {% elif order.status == 'CANCELLED' %}
                  <span class="badge bg-danger">Cancelada</span>
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <strong>Fecha de Creación:</strong>
                <span class="ms-2">{{ order.created_at|date:"d/m/Y H:i" }}</span>
              </div>

              <div class="mb-3">
                <strong>Última Actualización:</strong>
                <span class="ms-2">{{ order.updated_at|date:"d/m/Y H:i" }}</span>
              </div>

              <div class="mb-3">
                <strong>Creado por:</strong>
                <span class="ms-2">{{ order.created_by.name }}</span>
              </div>
            </div>
          </div>

          {% if order.notes %}
          <div class="mb-3">
            <strong>Notas:</strong>
            <div class="mt-2 p-3 bg-light rounded">{{ order.notes }}</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Actualización de Stock -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-boxes"></i> Actualización de Stock
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <strong>Estado de Actualización:</strong>
                <span class="ms-2">
                  {% if order.stock_updated_manually %}
                  <span class="badge bg-success">
                    <i class="fas fa-check"></i> Stock Actualizado Manualmente
                  </span>
                  {% else %}
                  <span class="badge bg-warning">
                    <i class="fas fa-exclamation-triangle"></i> Pendiente de Actualización
                  </span>
                  {% endif %}
                </span>
              </div>

              {% if order.stock_updated_manually and order.stock_updated_at %}
              <div class="mb-3">
                <strong>Actualizado el:</strong>
                <span class="ms-2">{{ order.stock_updated_at|date:"d/m/Y H:i" }}</span>
              </div>

              {% if order.stock_updated_by %}
              <div class="mb-3">
                <strong>Actualizado por:</strong>
                <span class="ms-2">{{ order.stock_updated_by.name }}</span>
              </div>
              {% endif %}
              {% endif %}
            </div>

            <div class="col-md-6">
              <form method="post" action="{% url 'repuestos:purchase_order_update_stock_status' order.pk %}">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="stock_updated" class="form-label"><strong>Marcar Stock como:</strong></label>
                  <select name="stock_updated" id="stock_updated" class="form-select">
                    <option value="false" {% if not order.stock_updated_manually %}selected{% endif %}>Pendiente de Actualización</option>
                    <option value="true" {% if order.stock_updated_manually %}selected{% endif %}>Actualizado Manualmente</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Actualizar Estado
                </button>
              </form>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Nota:</strong> Use esta opción para marcar cuando haya actualizado manualmente el stock en la sección de movimientos.
            Esto sirve como recordatorio para evitar duplicar movimientos de stock.
          </div>
        </div>
      </div>

      <!-- Items de la Orden -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-list"></i> Items de la Orden
          </h5>
        </div>
        <div class="card-body">
          {% if order.items.all %}
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Repuesto</th>
                  <th>Número Parte</th>
                  <th>Cantidad</th>
                  <th>Precio Unit.</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items.all %}
                <tr>
                  <td>
                    <strong>{{ item.repuesto.name }}</strong>
                    {% if item.repuesto.stock_info.description %}
                    <br><small class="text-muted">{{ item.repuesto.stock_info.description|truncatechars:50 }}</small>
                    {% endif %}
                  </td>
                  <td>{{ item.repuesto.stock_info.part_number|default:"-" }}</td>
                  <td>{{ item.quantity_ordered }}</td>
                  <td>${{ item.unit_price|floatformat:2 }}</td>
                  <td><strong>${{ item.total_price|floatformat:2 }}</strong></td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                  <td><strong>${{ order.subtotal|floatformat:2 }}</strong></td>
                </tr>
                <tr>
                  <td colspan="4" class="text-end"><strong>IVA (19%):</strong></td>
                  <td><strong>${{ order.tax_amount|floatformat:2 }}</strong></td>
                </tr>
                <tr class="table-dark">
                  <td colspan="4" class="text-end"><strong>Total:</strong></td>
                  <td><strong>${{ order.total_amount|floatformat:2 }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4">
            <p class="text-muted mb-0">No hay items en esta orden.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Panel Lateral -->
    <div class="col-lg-4">
      <!-- Resumen -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-calculator"></i> Resumen
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="card bg-light mb-2">
                <div class="card-body p-2">
                  <h4 class="mb-0">{{ order.items.count }}</h4>
                  <small class="text-muted">Items</small>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card bg-light mb-2">
                <div class="card-body p-2">
                  <h4 class="mb-0">${{ order.total_amount|floatformat:2 }}</h4>
                  <small class="text-muted">Total</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones Disponibles -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-bolt"></i> Acciones
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            {% if order.status == 'DRAFT' %}
            <a href="{% url 'repuestos:purchase_order_update' order.pk %}" class="btn btn-primary">
              <i class="fas fa-edit"></i> Editar Orden
            </a>

            <button type="button" class="btn btn-success" onclick="changeStatus('PENDING')">
              <i class="fas fa-paper-plane"></i> Enviar Orden
            </button>

            <button type="button" class="btn btn-danger" onclick="changeStatus('CANCELLED')">
              <i class="fas fa-times"></i> Cancelar Orden
            </button>
            {% endif %}

            {% if order.status == 'PENDING' %}
            <button type="button" class="btn btn-success" onclick="changeStatus('APPROVED')">
              <i class="fas fa-check"></i> Aprobar Orden
            </button>

            <button type="button" class="btn btn-info" onclick="changeStatus('RECEIVED')">
              <i class="fas fa-box-open"></i> Marcar como Recibida
            </button>
            {% endif %}

            {% if order.status == 'APPROVED' %}
            <button type="button" class="btn btn-warning" onclick="changeStatus('ORDERED')">
              <i class="fas fa-paper-plane"></i> Marcar como Ordenada
            </button>

            <button type="button" class="btn btn-info" onclick="changeStatus('RECEIVED')">
              <i class="fas fa-box-open"></i> Confirmar Recepción
            </button>
            {% endif %}

            {% if order.status == 'ORDERED' %}
            <button type="button" class="btn btn-info" onclick="changeStatus('RECEIVED')">
              <i class="fas fa-box-open"></i> Confirmar Recepción
            </button>
            {% endif %}

          </div>
        </div>
      </div>

      <!-- Información del Proveedor -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-building"></i> Información del Proveedor
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-2">
            <strong>{{ order.supplier.name }}</strong>
          </div>

          {% if order.supplier.contact_person %}
          <div class="mb-2">
            <strong>Contacto:</strong> {{ order.supplier.contact_person }}
          </div>
          {% endif %}

          {% if order.supplier.phone %}
          <div class="mb-2">
            <strong>Teléfono:</strong> {{ order.supplier.phone }}
          </div>
          {% endif %}

          {% if order.supplier.email %}
          <div class="mb-2">
            <strong>Email:</strong>
            <a href="mailto:{{ order.supplier.email }}">{{ order.supplier.email }}</a>
          </div>
          {% endif %}

          {% if order.supplier.address %}
          <div class="mb-2">
            <strong>Dirección:</strong>
            <small>{{ order.supplier.address }}</small>
          </div>
          {% endif %}

          <a href="{% url 'repuestos:supplier_detail' order.supplier.pk %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-eye"></i> Ver Proveedor
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cambiar Estado de la Orden</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'repuestos:purchase_order_change_status' order.pk %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="new_status" id="newStatusInput">
          <p>¿Está seguro de cambiar el estado de la orden a <strong id="statusText"></strong>?</p>
          <div class="mb-3">
            <label for="status_notes" class="form-label">Notas (opcional)</label>
            <textarea name="notes" id="status_notes" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Confirmar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function changeStatus(newStatus) {
  const statusTexts = {
    'PENDING': 'Pendiente',
    'APPROVED': 'Aprobada',
    'ORDERED': 'Ordenada',
    'RECEIVED': 'Recibida',
    'CANCELLED': 'Cancelada'
  };

  document.getElementById('newStatusInput').value = newStatus;
  document.getElementById('statusText').textContent = statusTexts[newStatus];
  new bootstrap.Modal(document.getElementById('statusModal')).show();
}
</script>
{% endblock %}
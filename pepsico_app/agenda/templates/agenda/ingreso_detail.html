{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle de Ingreso{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'agenda/css/formulario.css' %}">
<link rel="stylesheet" href="{% static 'agenda/css/ingreso_detail.css' %}">
{% endblock %}

{% block content %}
<div class="contenedor">
  <div class="formulario">
    <h2>Detalle de Ingreso</h2>

    <div class="detail-container">
      <div class="detail-field">
        <strong>ID:</strong> {{ ingreso.id_ingreso }}
      </div>
      <div class="detail-field">
        <strong>Patente:</strong> {{ ingreso.patent }}
      </div>
      <div class="detail-field">
        <strong>Entrada:</strong> {{ ingreso.entry_datetime }}
      </div>
      <div class="detail-field">
        <strong>Salida:</strong> {{ ingreso.exit_datetime|default:"Pendiente" }}
      </div>
      <div class="detail-field">
        <strong>Vendedor:</strong> {{ ingreso.chofer }}
      </div>
      <div class="detail-field">
        <strong>Observaciones:</strong> {{ ingreso.observations|default:"-" }}
      </div>
      <div class="detail-field">
        <strong>Sucursal de Origen:</strong> {{ ingreso.patent.site.name }}
      </div>
      <div class="detail-field">
        <strong>Ruta:</strong> {% for route in ingreso.patent.route_set.all %}{{ route.route_code }}{% if not forloop.last %}, {% endif %}{% endfor %}
      </div>
      <div class="detail-field">
        <strong>Autorización:</strong>
        {% if ingreso.authorization %}
          <span class="authorization-yes">Sí</span>
        {% else %}
          <span class="authorization-no">No</span>
        {% endif %}
      </div>
      <div class="detail-field">
        <strong>Salida Registrada Por:</strong> {{ ingreso.exit_registered_by|default:"-" }}
      </div>
      <div class="detail-field">
        <strong>Entrada Registrada Por:</strong> {{ ingreso.entry_registered_by|default:"-" }}
      </div>
      {% if ingreso.schedule %}
      <div class="detail-field">
        <strong>Agendamiento Relacionado:</strong>
        <span class="related-badge">ID {{ ingreso.schedule.id_schedule }}</span>
        <small class="related-time">Agendado: {{ ingreso.schedule.start_datetime|date:"d/m/Y H:i" }}</small>
      </div>
      {% endif %}
    </div>

    <!-- Sección de Imágenes -->
    <h3 class="related-title">Imágenes del Ingreso</h3>
    <div class="images-section">
      <!-- Galería de imágenes existentes -->
      <div class="images-gallery" id="images-gallery">
        {% for image in images %}
        <div class="image-item">
          <img src="{{ image.image.url }}" alt="{{ image.name }}" class="image-preview">
          <div class="image-info">
            <strong>{{ image.name }}</strong>
            <br>
            <small>Subido: {{ image.uploaded_at|date:"d/m/Y H:i" }}</small>
            {% if image.uploaded_by %}
            <br>
            <small>Por: {{ image.uploaded_by.name }}</small>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="no-images">
          <p>No hay imágenes subidas para este ingreso.</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Sección de Incidentes Relacionados -->
    {% if related_incidents %}
    <h3 class="related-title">Incidentes Relacionados</h3>
    <div class="incidents-section">
      {% for incident in related_incidents %}
      <div class="incident-item {% if incident.is_emergency %}emergency{% endif %}">
        <div class="incident-header">
          <h4>{{ incident.name }}</h4>
          <div class="incident-meta">
            <span class="incident-type">{{ incident.incident_type }}</span>
            <span class="incident-priority priority-{{ incident.priority|lower|default:'normal' }}">{{ incident.priority|default:'Normal' }}</span>
            {% if incident.is_emergency %}
            <span class="emergency-badge">EMERGENCIA</span>
            {% endif %}
          </div>
        </div>
        <div class="incident-details">
          <p class="incident-description">{{ incident.description|default:'Sin descripción' }}</p>
          <div class="incident-info">
            <small><strong>Reportado:</strong> {{ incident.reported_at|date:"d/m/Y H:i" }}</small>
            <br>
            <small><strong>ID Incidente:</strong> {{ incident.id_incident }}</small>
          </div>
          <div class="incident-actions">
            <a href="{% url 'incident_detail' incident.id_incident %}" class="btn btn-sm btn-info incident-detail-btn">
              <i class="fas fa-eye"></i> Detalles
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <h3 class="related-title">Agendamientos Relacionados</h3>
    {% if schedules %}
    <div class="related-schedules">
      {% for schedule in schedules %}
      <div class="schedule-item">
        {{ schedule.start_datetime }} - {{ schedule.end_datetime }}: {{ schedule.observations }}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="no-related">
      No hay agendamientos relacionados
    </div>
    {% endif %}

    <div class="back-section">
      <a href="{% url 'ingresos_list' %}" class="btn-programar">Volver a Lista de Ingresos</a>
      <br> <br>
      <a href="{% url 'orden_trabajo_list' %}" class="btn-programar">Volver a Órdenes de Trabajo</a>
    </div>
  </div>
</div>
{% endblock %}
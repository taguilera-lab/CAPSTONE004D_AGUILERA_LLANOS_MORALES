{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Ingresos{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'agenda/css/ingresos_list.css' %}">
<script src="{% static 'agenda/js/ingresos_list.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Lista de Ingresos</h1>
  
  <!-- Mostrar mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  
  <a href="{% url 'ingreso_create_select' %}" class="btn btn-primary mb-3">Crear Nuevo Ingreso</a>
  <a href="{% url 'orden_trabajo_list' %}" class="btn btn-success mb-3">
    <i class="fas fa-tools"></i> Gestionar Órdenes de Trabajo
  </a>
  <a href="{% url 'registrar_salida' %}" class="btn btn-secondary mb-3">Registrar Salida</a>
  <a href="{% url 'calendario' %}" class="btn btn-info mb-3">Ver Calendario</a>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Filtros</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2">
          <label for="filter-patent" class="form-label">Patente</label>
          <input type="text" class="form-control filter-input" id="filter-patent" data-column="1">
        </div>
        <div class="col-md-2">
          <label for="filter-service" class="form-label">Servicio</label>
          <input type="text" class="form-control filter-input" id="filter-service" data-column="2">
        </div>
        <div class="col-md-2">
          <label for="filter-entry" class="form-label">Entrada</label>
          <input type="date" class="form-control" id="filter-entry">
        </div>
        <div class="col-md-2">
          <label for="filter-exit" class="form-label">Salida</label>
          <input type="date" class="form-control" id="filter-exit">
        </div>
        <div class="col-md-2">
          <label for="filter-chofer" class="form-label">Chofer</label>
          <input type="text" class="form-control filter-input" id="filter-chofer" data-column="5">
        </div>
        <div class="col-md-2">
          <label for="filter-sucursal" class="form-label">Sucursal</label>
          <input type="text" class="form-control filter-input" id="filter-sucursal" data-column="6">
        </div>
        <div class="col-md-2">
          <label for="filter-agendado" class="form-label">Agendado</label>
          <select class="form-select filter-input" id="filter-agendado" data-column="7">
            <option value="">Todos</option>
            <option value="Agendado">Agendado</option>
            <option value="Directo">Directo</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="filter-autorizacion" class="form-label">Autorización</label>
          <select class="form-select filter-input" id="filter-autorizacion" data-column="8">
            <option value="">Todos</option>
            <option value="Sí">Sí</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="filter-entry-registered" class="form-label">Entrada Registrada Por</label>
          <input type="text" class="form-control filter-input" id="filter-entry-registered" data-column="9">
        </div>
        <div class="col-md-2">
          <label for="filter-exit-registered" class="form-label">Salida Registrada Por</label>
          <input type="text" class="form-control filter-input" id="filter-exit-registered" data-column="10">
        </div>
        <div class="col-md-12">
          <button type="button" class="btn btn-outline-secondary me-2" id="clear-filters">Limpiar Filtros</button>
          <span class="text-muted" id="results-count"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Patente</th>
          <th>Servicio</th>
          <th>Entrada</th>
          <th>Salida</th>
          <th>Chofer</th>
          <th>Sucursal</th>
          <th>Agendado</th>
          <th>Autorización para salir</th>
          <th>Entrada Registrada Por</th>
          <th>Salida Registrada Por</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for ingreso in ingresos %}
        <tr>
          <td>{{ ingreso.id_ingreso }}</td>
          <td>{{ ingreso.patent }}</td>
          <td>{{ ingreso.service_type|default:"Sin especificar" }}</td>
          <td>{{ ingreso.entry_datetime }}</td>
          <td>{{ ingreso.exit_datetime|default:"-" }}</td>
          <td>{{ ingreso.chofer }}</td>
          <td>{{ ingreso.patent.site.name }}</td>
          <td>
            {% if ingreso.schedule %}
              <span class="badge bg-info">Agendado</span>
            {% else %}
              <span class="badge bg-secondary">Directo</span>
            {% endif %}
          </td>
          <td>
            {% if ingreso.authorization %}
              <span class="badge bg-success">Sí</span>
            {% else %}
              <span class="badge bg-danger">No</span>
            {% endif %}
          </td>
          <td>{{ ingreso.entry_registered_by|default:"-" }}</td>
          <td>{{ ingreso.exit_registered_by|default:"-" }}</td>
          <td><a href="{% url 'ingreso_detail' ingreso.id_ingreso %}" class="btn btn-sm btn-info">Ver</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
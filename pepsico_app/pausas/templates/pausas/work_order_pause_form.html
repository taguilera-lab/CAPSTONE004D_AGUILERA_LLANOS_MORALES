{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Pausa en Orden de Trabajo{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">
            <i class="fas fa-clock"></i> Nueva Pausa en Orden de Trabajo
          </h4>
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Importante:</strong> Todas las pausas requieren asignar un mecánico específico,
            salvo la pausa global por falta de repuestos (STOCK) que afecta a todos los mecánicos.
          </div>

          <form method="post" id="pause-form">
            {% csrf_token %}

            <!-- Selección de Orden de Trabajo -->
            <div class="mb-3">
              <label for="{{ form.work_order.id_for_label }}" class="form-label">
                Orden de Trabajo <span class="text-danger">*</span>
              </label>
              {{ form.work_order }}
              {% if form.work_order.errors %}
                <div class="text-danger">{{ form.work_order.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Selección de Mecánico -->
            <div class="mb-3">
              <label for="{{ form.mechanic_assignment.id_for_label }}" class="form-label">
                Mecánico Asignado <span class="text-danger" id="mechanic-required">*</span>
              </label>
              {{ form.mechanic_assignment }}
              {% if form.mechanic_assignment.errors %}
                <div class="text-danger">{{ form.mechanic_assignment.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Seleccione el mecánico afectado por la pausa</div>
            </div>

            <!-- Tipo de Pausa -->
            <div class="mb-3">
              <label for="{{ form.pause_type.id_for_label }}" class="form-label">
                Tipo de Pausa <span class="text-danger">*</span>
              </label>
              {{ form.pause_type }}
              {% if form.pause_type.errors %}
                <div class="text-danger">{{ form.pause_type.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Motivo -->
            <div class="mb-3">
              <label for="{{ form.reason.id_for_label }}" class="form-label">
                Motivo <span class="text-danger">*</span>
              </label>
              {{ form.reason }}
              {% if form.reason.errors %}
                <div class="text-danger">{{ form.reason.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Describa brevemente el motivo de la pausa</div>
            </div>

            <!-- Repuesto Afectado (solo para pausas por falta de stock) -->
            <div class="mb-3" id="spare-part-field" style="display: none;">
              <label for="{{ form.affected_spare_part.id_for_label }}" class="form-label">
                Repuesto Afectado
              </label>
              {{ form.affected_spare_part }}
              {% if form.affected_spare_part.errors %}
                <div class="text-danger">{{ form.affected_spare_part.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Seleccione el repuesto que falta para continuar con el trabajo</div>
            </div>

            <!-- Fecha y Hora de Inicio -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.start_date.id_for_label }}" class="form-label">
                  Fecha de Inicio <span class="text-danger">*</span>
                </label>
                {{ form.start_date }}
                {% if form.start_date.errors %}
                  <div class="text-danger">{{ form.start_date.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.start_time.id_for_label }}" class="form-label">
                  Hora de Inicio <span class="text-danger">*</span>
                </label>
                {{ form.start_time }}
                {% if form.start_time.errors %}
                  <div class="text-danger">{{ form.start_time.errors.0 }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Requiere Autorización -->
            <div class="mb-3" id="authorization-field" style="display: none;">
              <div class="form-check">
                {{ form.requires_authorization }}
                <label for="{{ form.requires_authorization.id_for_label }}" class="form-check-label">
                  Requiere autorización especial
                </label>
              </div>
              <div class="form-text">Esta pausa necesita aprobación antes de continuar</div>
            </div>

            <!-- Notas Adicionales -->
            <div class="mb-3">
              <label for="{{ form.notes.id_for_label }}" class="form-label">
                Notas Adicionales
              </label>
              {{ form.notes }}
              {% if form.notes.errors %}
                <div class="text-danger">{{ form.notes.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Botones -->
            <div class="d-flex justify-content-between">
              <a href="{% url 'pausas:work_order_pause_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancelar
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Crear Pausa
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
  // Mostrar/ocultar campo de repuesto basado en el tipo de pausa
  function toggleSparePartField() {
    var selectedType = $('#{{ form.pause_type.id_for_label }}').val();
    var sparePartField = $('#spare-part-field');

    if (selectedType) {
      // Aquí puedes agregar lógica específica para tipos de pausa que requieren repuesto
      // Por ahora, mostramos el campo para todos los tipos
      sparePartField.show();
    } else {
      sparePartField.hide();
    }
  }

  // Mostrar/ocultar campo de autorización basado en el tipo de pausa
  function toggleAuthorizationField() {
    var selectedType = $('#{{ form.pause_type.id_for_label }}').val();
    var authField = $('#authorization-field');

    if (selectedType) {
      // Aquí puedes agregar lógica específica para tipos que requieren autorización
      authField.show();
    } else {
      authField.hide();
    }
  }

  // Event listeners
  $('#{{ form.pause_type.id_for_label }}').change(function() {
    toggleSparePartField();
    toggleAuthorizationField();
  });

  // Cargar mecánicos cuando se selecciona una OT
  $('#{{ form.work_order.id_for_label }}').change(function() {
    var workOrderId = $(this).val();
    var mechanicField = $('#{{ form.mechanic_assignment.id_for_label }}');

    if (workOrderId) {
      $.ajax({
        url: '{% url "pausas:ajax_load_mechanics" %}',
        data: { 'work_order_id': workOrderId },
        success: function(data) {
          mechanicField.empty();
          mechanicField.append('<option value="">Seleccione mecánico (opcional)</option>');
          $.each(data.mechanics, function(index, mechanic) {
            mechanicField.append('<option value="' + mechanic.id_mechanic_assignment + '">' + mechanic.mechanic__name + '</option>');
          });
        },
        error: function(xhr, status, error) {
          console.error('Error loading mechanics:', error);
          mechanicField.empty();
          mechanicField.append('<option value="">Error al cargar mecánicos</option>');
        }
      });
    } else {
      mechanicField.empty();
      mechanicField.append('<option value="">Primero seleccione una OT</option>');
    }
  });

  // Inicializar campos
  toggleSparePartField();
  toggleAuthorizationField();

  // Lógica para mostrar/ocultar campo de mecánico según tipo de pausa
  const pauseTypeSelect = document.getElementById('{{ form.pause_type.id_for_label }}');
  const mechanicField = document.getElementById('{{ form.mechanic_assignment.id_for_label }}').closest('.mb-3');
  const mechanicRequired = document.getElementById('mechanic-required');
  const mechanicInput = document.getElementById('{{ form.mechanic_assignment.id_for_label }}');

  function toggleMechanicField() {
    const selectedPauseType = pauseTypeSelect.value;
    
    if (selectedPauseType === 'STOCK') {
      // Para STOCK, ocultar campo de mecánico y quitar requerido
      mechanicField.style.display = 'none';
      mechanicRequired.style.display = 'none';
      mechanicInput.required = false;
    } else {
      // Para otros tipos, mostrar campo de mecánico y hacer requerido
      mechanicField.style.display = 'block';
      mechanicRequired.style.display = 'inline';
      mechanicInput.required = true;
    }
  }

  // Ejecutar al cargar la página
  toggleMechanicField();
  
  // Ejecutar cuando cambie el tipo de pausa
  pauseTypeSelect.addEventListener('change', toggleMechanicField);
});
</script>
{% endblock %}
{% endblock %}
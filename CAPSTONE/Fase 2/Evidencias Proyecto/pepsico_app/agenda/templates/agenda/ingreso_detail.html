{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle de Ingreso{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'agenda/css/formulario.css' %}">
<link rel="stylesheet" href="{% static 'agenda/css/ingreso_detail.css' %}">
<script src="{% static 'agenda/js/ingreso_detail.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar el botón de diagnóstico con los datos del ingreso
    initDiagnosticoButton({{ ingreso.id_ingreso }}, '{{ ingreso.patent }}');
});
</script>
{% endblock %}

{% block content %}
<div class="contenedor">
  <div class="formulario">
    <!-- Token CSRF para AJAX -->
    {% csrf_token %}
    
    <div class="header-actions">
      <h2>Detalle de Ingreso</h2>
      {% if ingreso.es_ingreso_tecnico %}
      <div class="action-buttons">
        <button class="btn-diagnostico">
          <i class="fas fa-stethoscope"></i> Realizar Diagnóstico
        </button>
      </div>
      {% else %}
      <div class="warning-message">
        <div class="alert alert-warning" role="alert">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Atención:</strong> Primero realizar ingreso técnico antes de hacer diagnóstico
        </div>
      </div>
      {% endif %}
    </div>

    <div class="detail-container">
      <div class="detail-field">
        <strong>ID:</strong> {{ ingreso.id_ingreso }}
      </div>
      <div class="detail-field">
        <strong>Patente:</strong> {{ ingreso.patent }}
      </div>
      <div class="detail-field">
        <strong>Entrada:</strong> {{ ingreso.entry_datetime }}
      </div>
      <div class="detail-field">
        <strong>Salida:</strong> {{ ingreso.exit_datetime|default:"Pendiente" }}
      </div>
      <div class="detail-field">
        <strong>Vendedor:</strong> {{ ingreso.chofer }}
      </div>
      <div class="detail-field">
        <strong>Observaciones:</strong> {{ ingreso.observations|default:"-" }}
      </div>
      <div class="detail-field">
        <strong>Sucursal de Origen:</strong> {{ ingreso.patent.site.name }}
      </div>
      <div class="detail-field">
        <strong>Ruta:</strong> {% for route in ingreso.patent.routes.all %}{{ route.route_code }}{% if not forloop.last %}, {% endif %}{% endfor %}
      </div>
      <div class="detail-field">
        <strong>Autorización para salir:</strong>
        {% if ingreso.authorization %}
          <span class="authorization-yes">Sí</span>
        {% else %}
          <span class="authorization-no">No</span>
        {% endif %}
      </div>
      <div class="detail-field">
        <strong>Ingreso Técnico:</strong>
        {% if ingreso.es_ingreso_tecnico %}
          <span class="authorization-yes"><i class="fas fa-check-circle"></i> Completado</span>
        {% else %}
          <span class="authorization-no">Pendiente</span>
        {% endif %}
      </div>
      
      <!-- Badges de estado -->
      <div class="detail-field">
        <strong>Estado:</strong>
        <div class="status-badges">
          {% if ingreso.diagnostics.exists %}
            <span class="badge bg-info"><i class="fas fa-stethoscope"></i> Diagnóstico Ordenado</span>
          {% endif %}
          {% if ingreso.work_orders.exists %}
            <span class="badge bg-primary"><i class="fas fa-tools"></i> OT Ordenada</span>
          {% endif %}
        </div>
      </div>
      
      <div class="detail-field">
        <strong>Salida Registrada Por:</strong> {{ ingreso.exit_registered_by|default:"-" }}
      </div>
      <div class="detail-field">
        <strong>Entrada Registrada Por:</strong> {{ ingreso.entry_registered_by|default:"-" }}
      </div>
      {% if ingreso.schedule %}
      <div class="detail-field">
        <strong>Agendamiento Relacionado:</strong>
        <span class="related-badge">ID {{ ingreso.schedule.id_schedule }}</span>
        <small class="related-time">Agendado: {{ ingreso.schedule.start_datetime|date:"d/m/Y H:i" }}</small>
      </div>
      {% endif %}
    </div>

    <!-- Sección de Imágenes -->
    <h3 class="related-title">Imágenes del Ingreso</h3>
    <div class="images-section">
      <!-- Galería de imágenes existentes -->
      <div class="images-gallery" id="images-gallery">
        {% for image in images %}
        <div class="image-item">
          <img src="{{ image.image.url }}" alt="{{ image.name }}" class="image-preview"
               onclick="openImageModal('{{ image.image.url }}', '{{ image.name }}', '{{ image.description }}', '{{ image.uploaded_at|date:'d/m/Y H:i' }}', '{{ image.uploaded_by.name }}')"
               style="cursor: pointer;">
          <div class="image-info">
            <strong>{{ image.name }}</strong>
            <br>
            <small>Subido: {{ image.uploaded_at|date:"d/m/Y H:i" }}</small>
            {% if image.uploaded_by %}
            <br>
            <small>Por: {{ image.uploaded_by.name }}</small>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="no-images">
          <p>No hay imágenes subidas para este ingreso.</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Sección de Incidentes Relacionados -->
    {% if related_incidents %}
    <h3 class="related-title">Incidentes Relacionados</h3>
    <div class="incidents-section">
      {% for incident in related_incidents %}
      <div class="incident-item {% if incident.is_emergency %}emergency{% endif %}">
        <div class="incident-header">
          <h4>{{ incident.name }}</h4>
          <div class="incident-meta">
            <span class="incident-type">{{ incident.incident_type }}</span>
            <span class="incident-priority priority-{{ incident.priority|lower|default:'normal' }}">{{ incident.priority|default:'Normal' }}</span>
            {% if incident.is_emergency %}
            <span class="emergency-badge">EMERGENCIA</span>
            {% endif %}
          </div>
        </div>
        <div class="incident-details">
          <p class="incident-description">{{ incident.description|default:'Sin descripción' }}</p>
          <div class="incident-info">
            <small><strong>Reportado por:</strong> {{ incident.reported_by.name }}</small>
            <br>
            <small><strong>Reportado:</strong> {{ incident.reported_at|date:"d/m/Y H:i" }}</small>
            <br>
            <small><strong>ID Incidente:</strong> {{ incident.id_incident }}</small>
          </div>
          <div class="incident-actions">
            <a href="{% url 'incidents:incident_detail' incident.id_incident %}" class="btn btn-sm btn-info incident-detail-btn">
              <i class="fas fa-eye"></i> Detalles
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <h3 class="related-title">Agendamientos Relacionados</h3>
    {% if schedules %}
    <div class="related-schedules">
      {% for schedule in schedules %}
      <div class="schedule-item">
        {{ schedule.start_datetime }} - {{ schedule.end_datetime }}: {{ schedule.observations }}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="no-related">
      No hay agendamientos relacionados
    </div>
    {% endif %}

    <div class="back-section">
      <a href="{% url 'ingresos_list' %}" class="btn-programar">Volver a Lista de Ingresos</a>
      <br> <br>
      <a href="{% url 'orden_trabajo_list' %}" class="btn-programar">Volver a Órdenes de Trabajo</a>
    </div>
  </div>
</div>

<script>
// Función para abrir el modal de imagen
function openImageModal(imageUrl, name, description, date, user) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('modalImageName').textContent = name;
    document.getElementById('modalImageDescription').textContent = description || 'Sin descripción';
    document.getElementById('modalImageDate').textContent = date;
    document.getElementById('modalImageUser').textContent = user;

    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    imageModal.show();
}
</script>

<!-- Modal para ampliar imágenes -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Vista de Imagen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid rounded" alt="Imagen" style="max-height: 70vh;">
        <div class="mt-3">
          <h6 id="modalImageName"></h6>
          <p class="text-muted mb-1" id="modalImageDescription"></p>
          <small class="text-muted">
            Subida el <span id="modalImageDate"></span> por <span id="modalImageUser"></span>
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
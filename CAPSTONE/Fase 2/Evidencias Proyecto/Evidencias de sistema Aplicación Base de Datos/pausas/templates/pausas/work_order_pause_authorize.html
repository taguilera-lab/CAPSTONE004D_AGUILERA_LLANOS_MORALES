{% extends 'base.html' %}
{% load static %}

{% block title %}Autorizar Pausa - OT-{{ pause.work_order.id_work_order }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card border-primary">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-check-circle"></i> Autorizar Pausa
          </h4>
        </div>
        <div class="card-body">
          <!-- Información de la Pausa -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Detalles de la Pausa</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <table class="table table-sm">
                    <tr>
                      <th width="40%">Orden de Trabajo:</th>
                      <td>OT-{{ pause.work_order.id_work_order }}</td>
                    </tr>
                    <tr>
                      <th>Tipo:</th>
                      <td>{{ pause.pause_type.name }}</td>
                    </tr>
                    <tr>
                      <th>Mecánico:</th>
                      <td>
                        {% if pause.mechanic_assignment %}
                          {{ pause.mechanic_assignment.mechanic.name }}
                        {% else %}
                          General
                        {% endif %}
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <table class="table table-sm">
                    <tr>
                      <th width="40%">Inicio:</th>
                      <td>{{ pause.start_datetime|date:"d/m/Y H:i:s" }}</td>
                    </tr>
                    <tr>
                      <th>Duración:</th>
                      <td>{{ pause.start_datetime|timesince }}</td>
                    </tr>
                    <tr>
                      <th>Estado:</th>
                      <td>
                        <span class="badge bg-warning">Pendiente de Autorización</span>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>

              <div class="mt-3">
                <h6>Motivo:</h6>
                <p class="mb-2">{{ pause.reason }}</p>

                {% if pause.affected_spare_part %}
                <h6>Repuesto Afectado:</h6>
                <p class="mb-2">{{ pause.affected_spare_part.name }}</p>
                {% endif %}

                {% if pause.notes %}
                <h6>Notas:</h6>
                <p class="mb-0">{{ pause.notes }}</p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Formulario de Autorización -->
          <form method="post">
            {% csrf_token %}

            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <strong>Autorización Requerida:</strong>
              Esta pausa requiere aprobación especial antes de que el trabajo pueda continuar.
            </div>

            <!-- Decisión -->
            <div class="mb-3">
              <label class="form-label">Decisión <span class="text-danger">*</span></label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="decision" id="approve" value="approve" checked>
                <label class="form-check-label" for="approve">
                  <i class="fas fa-check text-success"></i> Aprobar Pausa
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="decision" id="reject" value="reject">
                <label class="form-check-label" for="reject">
                  <i class="fas fa-times text-danger"></i> Rechazar Pausa
                </label>
              </div>
            </div>

            <!-- Comentarios de Autorización -->
            <div class="mb-3">
              <label for="id_authorization_notes" class="form-label">
                Comentarios de Autorización <span class="text-danger">*</span>
              </label>
              <textarea name="authorization_notes" id="id_authorization_notes" class="form-control" rows="4"
                        placeholder="Explique su decisión de aprobación o rechazo..." required></textarea>
              <div class="form-text">Estos comentarios serán visibles en el historial de la pausa</div>
            </div>

            <!-- Botones -->
            <div class="d-flex justify-content-between">
              <a href="{% url 'pausas:work_order_pause_detail' pause.id_pause %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancelar
              </a>
              <div>
                <button type="submit" name="decision" value="reject" class="btn btn-danger me-2">
                  <i class="fas fa-times"></i> Rechazar
                </button>
                <button type="submit" name="decision" value="approve" class="btn btn-success">
                  <i class="fas fa-check"></i> Aprobar
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
  // Cambiar placeholder basado en la decisión
  $('input[name="decision"]').change(function() {
    var decision = $(this).val();
    var textarea = $('#id_authorization_notes');

    if (decision === 'approve') {
      textarea.attr('placeholder', 'Explique por qué aprueba esta pausa...');
    } else {
      textarea.attr('placeholder', 'Explique por qué rechaza esta pausa y qué acciones alternativas recomienda...');
    }
  });
});
</script>
{% endblock %}
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Ingreso Técnico - Recepcionista{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'agenda/css/formulario.css' %}">
<link rel="stylesheet" href="{% static 'agenda/css/ingreso_tecnico.css' %}">
{% endblock %}

{% block content %}
<div class="contenedor">
  <div class="formulario">
    <h2>Ingreso Técnico - Registro de Estado del Vehículo</h2>
    <p class="page-description">
      Capture fotos del estado actual del vehículo para documentar su condición al momento del ingreso.
      Estas fotos servirán como baseline antes de cualquier trabajo de mantenimiento.
    </p>

    {% if error %}
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    <!-- Información del Ingreso y Vehículo -->
    <div class="info-section">
      <h3><i class="fas fa-info-circle"></i> Información del Ingreso</h3>
      <div class="info-grid">
        <div class="info-card">
          <h4>Datos del Ingreso</h4>
          <div class="info-detail">
            <strong>ID Ingreso:</strong> {{ ingreso.id_ingreso }}
          </div>
          <div class="info-detail">
            <strong>Fecha de Entrada:</strong> {{ ingreso.entry_datetime|date:"d/m/Y H:i" }}
          </div>
          <div class="info-detail">
            <strong>Chofer:</strong> {{ ingreso.chofer.name }}
          </div>
          <div class="info-detail">
            <strong>Estado:</strong>
            {% if ingreso.exit_datetime %}
              <span class="status-completed">Completado</span>
            {% else %}
              <span class="status-active">Activo</span>
            {% endif %}
          </div>
          {% if ingreso.observations %}
          <div class="info-detail">
            <strong>Observaciones:</strong> {{ ingreso.observations }}
          </div>
          {% endif %}
        </div>

        <div class="info-card">
          <h4>Datos del Vehículo</h4>
          <div class="info-detail">
            <strong>Patente:</strong> {{ vehicle.patent }}
          </div>
          <div class="info-detail">
            <strong>Marca:</strong> {{ vehicle.brand|default:"N/A" }}
          </div>
          <div class="info-detail">
            <strong>Modelo:</strong> {{ vehicle.model|default:"N/A" }}
          </div>
          <div class="info-detail">
            <strong>Sucursal:</strong> {{ vehicle.site.name|default:"N/A" }}
          </div>
          <div class="info-detail">
            <strong>Rutas:</strong>
            {% for route in routes %}
              {{ route.route_code }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              N/A
            {% endfor %}
          </div>
        </div>
      </div>

      {% if has_schedule %}
      <div class="schedule-actions">
        <a href="{% url 'schedule_detail' ingreso.schedule.id_schedule %}" class="btn btn-outline-primary">
          <i class="fas fa-calendar"></i> Ver Detalles del Agendamiento
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Captura de Fotos -->
    <div class="photo-capture-section">
      <h3><i class="fas fa-camera"></i> Captura de Fotos del Estado del Vehículo</h3>
      <p>Capture las siguientes fotos para documentar completamente el estado del vehículo:</p>

      <form id="photo-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="camera-container">
          <video id="camera" autoplay playsinline></video>
          <canvas id="canvas" style="display: none;"></canvas>
        </div>

        <div class="photo-instructions">
          <div class="instruction-grid">
            <div class="photo-item" data-photo="0">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Estado Frontal</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="0">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>

            <div class="photo-item" data-photo="1">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Lateral Izquierdo</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="1">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>

            <div class="photo-item" data-photo="2">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Lateral Derecho</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="2">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>

            <div class="photo-item" data-photo="3">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Estado Trasero</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="3">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>

            <div class="photo-item" data-photo="4">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Estado del Motor</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="4">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>

            <div class="photo-item" data-photo="5">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Estado de Neumáticos</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="5">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>

            <div class="photo-item" data-photo="6">
              <div class="photo-placeholder">
                <i class="fas fa-camera"></i>
                <span>Daños Externos</span>
              </div>
              <button type="button" class="take-photo-btn btn btn-primary btn-sm" data-index="6">
                <i class="fas fa-camera"></i> Capturar
              </button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <a href="{% url 'ingresos_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Ingresos
          </a>
          <button type="submit" id="submit-btn" class="btn btn-success" disabled>
            <i class="fas fa-save"></i> Registrar Ingreso Técnico
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="{% static 'agenda/js/ingreso_tecnico.js' %}"></script>
{% endblock %}
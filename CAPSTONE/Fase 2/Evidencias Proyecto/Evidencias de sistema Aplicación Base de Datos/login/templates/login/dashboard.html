{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - {{ role }}{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'login/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="contenedor">
    <div class="formulario">
        <h2>Bienvenido, {{ role }}</h2>

        {% if role == "Recepcionista de Vehículos" %}
        <div class="dashboard-section">
            <h3><i class="fas fa-list"></i> Gestión de Ingresos</h3>
            <p>Ver y gestionar todos los ingresos registrados.</p>
            <a href="{% url 'ingresos_list' %}" class="btn btn-secondary">
                <i class="fas fa-eye"></i> Ver Ingresos
            </a>
        </div>
        {% endif %}

        {% if role == "Supervisor" or role == "Jefe de Flota" and kpis %}
        <div class="dashboard-section">
            <h3><i class="fas fa-chart-line"></i> KPIs Diarios</h3>
            <form method="get" class="mb-3 d-flex align-items-center gap-2">
                <label for="kpi_date" class="form-label mb-0">Seleccionar fecha:</label>
                <input type="date" id="kpi_date" name="kpi_date" value="{{ selected_kpi_date|date:'Y-m-d' }}" class="form-control form-control-sm" style="width: auto;">
                <button type="submit" class="btn btn-primary btn-sm">Actualizar</button>
            </form>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.ingresos_today }}</div>
                    <div class="kpi-label">Vehículos Ingresados</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.salidas_today }}</div>
                    <div class="kpi-label">Vehículos Salidos</div>
                </div>
            </div>
        </div>

        <div class="dashboard-section">
            <h3><i class="fas fa-calendar-alt"></i> KPIs Mensuales</h3>
            <p class="section-description">Métricas del último mes (30 días)</p>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.active_work_orders }}</div>
                    <div class="kpi-label">Órdenes de Trabajo Activas</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.vehicles_in_workshop }}</div>
                    <div class="kpi-label">Vehículos en Taller</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.documents_last_month }}</div>
                    <div class="kpi-label">Documentos Subidos</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.completed_work_orders_last_month }}</div>
                    <div class="kpi-label">OTs Completadas</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.active_supervisor_users }}</div>
                    <div class="kpi-label">Usuarios Activos (Administrativos)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.productivity_ratio }}%</div>
                    <div class="kpi-label">Eficiencia de Trabajo</div>
                    <div class="kpi-formula">
                        <small class="text-muted">Fórmula: (Horas trabajadas / Total tiempo) × 100</small>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.total_man_hours_last_month }}</div>
                    <div class="kpi-label">Horas Hombre</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.total_pause_time_last_month }}h</div>
                    <div class="kpi-label">Tiempo Total de Pausas</div>
                </div>
            </div>
            <div class="kpi-refresh">
                <small class="text-muted">Los datos se actualizan automáticamente al recargar la página (F5)</small>
            </div>
        </div>

        <!-- Productividad por Mecánico -->
        <div class="dashboard-section">
            <h3><i class="fas fa-users"></i> Productividad por Mecánico (Último Mes)</h3>
            <p class="section-description">Eficiencia individual de cada mecánico basada en horas trabajadas vs tiempo total</p>
            
            <div class="mechanic-productivity-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mecánico</th>
                                <th>Horas Trabajadas</th>
                                <th>Horas de Pausa</th>
                                <th>Productividad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mechanic_data in mechanic_productivity %}
                            <tr>
                                <td><strong>{{ mechanic_data.mechanic.name }}</strong></td>
                                <td>{{ mechanic_data.worked_hours }}h</td>
                                <td>{{ mechanic_data.pause_hours }}h</td>
                                <td>
                                    <span class="productivity-badge 
                                        {% if mechanic_data.productivity >= 90 %}badge-success
                                        {% elif mechanic_data.productivity >= 70 %}badge-warning
                                        {% else %}badge-danger{% endif %}">
                                        {{ mechanic_data.productivity }}%
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay datos de mecánicos disponibles</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="productivity-legend mt-3">
                    <small class="text-muted">
                        <strong>Leyenda:</strong> 
                        <span class="badge-success">≥90%</span> Excelente | 
                        <span class="badge-warning">70-89%</span> Bueno | 
                        <span class="badge-danger"><90%</span> Requiere atención
                    </small>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="dashboard-section">
            <h3><i class="fas fa-chart-bar"></i> Análisis Visual y Estadísticas Operativas</h3>
            <p class="section-description">Visualización detallada de métricas y tendencias del taller</p>
            <div class="charts-grid">
                <!-- Gráfico de Barras: Órdenes por Estado -->
                <div class="chart-container">
                    <h4>Órdenes de Trabajo por Estado</h4>
                    <form method="get" class="mb-3">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="view_type" id="daily" value="daily" {% if view_type == 'daily' %}checked{% endif %}>
                                <label class="form-check-label" for="daily">
                                    Diario
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="view_type" id="monthly" value="monthly" {% if view_type == 'monthly' %}checked{% endif %}>
                                <label class="form-check-label" for="monthly">
                                    Mensual (último mes)
                                </label>
                            </div>
                        </div>
                        <div id="date-picker" class="d-flex align-items-center gap-2 {% if view_type == 'monthly' %}d-none{% endif %}">
                            <label for="date" class="form-label mb-0">Seleccionar fecha:</label>
                            <input type="date" id="date" name="date" value="{{ selected_date|date:'Y-m-d' }}" class="form-control form-control-sm" style="width: auto;">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm mt-2">Filtrar</button>
                    </form>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>

                <!-- Gráfico Circular: Tipos de Servicio -->
                <div class="chart-container">
                    <h4>Distribución por Tipo de Servicio</h4>
                    <canvas id="serviceChart" width="400" height="200"></canvas>
                </div>

                <!-- Gráfico de Líneas: Tendencia Mensual -->
                <div class="chart-container">
                    <h4>Tendencia de Órdenes Completadas</h4>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>

                <!-- Gráfico de Barras: Documentos por Tipo -->
                <div class="chart-container">
                    <h4>Documentos por Tipo</h4>
                    <canvas id="documentsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="dashboard-actions">
            <a href="{% url 'logout' %}" class="btn btn-secondary">Cerrar Sesión</a>
        </div>
    </div>
</div>

{% if role == "Supervisor" or role == "Jefe de Flota" and charts %}
<script>
// Datos para los gráficos
const statusLabels = {{ charts.status_labels|safe }};
const statusCounts = {{ charts.status_counts|safe }};
const serviceLabels = {{ charts.service_labels|safe }};
const serviceCounts = {{ charts.service_counts|safe }};
const trendLabels = {{ charts.trend_labels|safe }};
const trendCompleted = {{ charts.trend_completed|safe }};
const docTypeLabels = {{ charts.doc_type_labels|safe }};
const docTypeCounts = {{ charts.doc_type_counts|safe }};

// Colores para los gráficos
const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
    '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
];

// Gráfico de Barras: Órdenes por Estado
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'bar',
    data: {
        labels: statusLabels,
        datasets: [{
            label: 'Cantidad',
            data: statusCounts,
            backgroundColor: colors.slice(0, statusLabels.length),
            borderColor: colors.slice(0, statusLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});

// Gráfico Circular: Tipos de Servicio
const serviceCtx = document.getElementById('serviceChart').getContext('2d');
new Chart(serviceCtx, {
    type: 'doughnut',
    data: {
        labels: serviceLabels,
        datasets: [{
            data: serviceCounts,
            backgroundColor: colors.slice(0, serviceLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// Gráfico de Líneas: Tendencia Mensual
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: trendLabels,
        datasets: [{
            label: 'Órdenes Completadas',
            data: trendCompleted,
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});

// Gráfico de Barras: Documentos por Tipo
const documentsCtx = document.getElementById('documentsChart').getContext('2d');
new Chart(documentsCtx, {
    type: 'bar',
    data: {
        labels: docTypeLabels,
        datasets: [{
            label: 'Cantidad',
            data: docTypeCounts,
            backgroundColor: colors.slice(0, docTypeLabels.length),
            borderColor: colors.slice(0, docTypeLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});

// JavaScript para mostrar/ocultar el selector de fecha
document.querySelectorAll('input[name="view_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const datePicker = document.getElementById('date-picker');
        if (this.value === 'daily') {
            datePicker.classList.remove('d-none');
        } else {
            datePicker.classList.add('d-none');
        }
    });
});
</script>
{% endif %}
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - {{ role }}{% endblock %}

{% block static %}
<link rel="stylesheet" href="{% static 'login/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="contenedor">
    <div class="formulario">
        <h2>Bienvenido, {{ role }}</h2>

        {% if role == "Recepcionista de Vehículos" %}
        <div class="dashboard-section">
            <h3><i class="fas fa-list"></i> Gestión de Ingresos</h3>
            <p>Ver y gestionar todos los ingresos registrados.</p>
            <a href="{% url 'ingresos_list' %}" class="btn btn-secondary">
                <i class="fas fa-eye"></i> Ver Ingresos
            </a>
        </div>
        {% endif %}

        {% if role == "Supervisor" or role == "Jefe de Flota" and kpis %}
        <div class="dashboard-section">
            <h3><i class="fas fa-chart-line"></i> KPIs Operativos</h3>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.active_work_orders }}</div>
                    <div class="kpi-label">Órdenes de Trabajo Activas</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.vehicles_in_workshop }}</div>
                    <div class="kpi-label">Vehículos en Taller</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.documents_last_month }}</div>
                    <div class="kpi-label">Documentos (Último Mes)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.completed_work_orders_last_month }}</div>
                    <div class="kpi-label">OTs Completadas (Último Mes)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.active_supervisor_users }}</div>
                    <div class="kpi-label">Usuarios Activos (Administrativos)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.productivity_ratio }}%</div>
                    <div class="kpi-label">Tasa de Productividad</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">{{ kpis.total_man_hours_last_month }}</div>
                    <div class="kpi-label">Horas Hombre (Último Mes)</div>
                </div>
            </div>
            <div class="kpi-refresh">
                <small class="text-muted">Los datos se actualizan automáticamente al recargar la página (F5)</small>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="dashboard-section">
            <h3><i class="fas fa-chart-bar"></i> Análisis Visual y Estadísticas Operativas</h3>
            <p class="section-description">Visualización detallada de métricas y tendencias del taller</p>
            <div class="charts-grid">
                <!-- Gráfico de Barras: Órdenes por Estado -->
                <div class="chart-container">
                    <h4>Órdenes de Trabajo por Estado</h4>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>

                <!-- Gráfico Circular: Tipos de Servicio -->
                <div class="chart-container">
                    <h4>Distribución por Tipo de Servicio</h4>
                    <canvas id="serviceChart" width="400" height="200"></canvas>
                </div>

                <!-- Gráfico de Líneas: Tendencia Mensual -->
                <div class="chart-container">
                    <h4>Tendencia de Órdenes Completadas</h4>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>

                <!-- Gráfico de Barras: Documentos por Tipo -->
                <div class="chart-container">
                    <h4>Documentos por Tipo</h4>
                    <canvas id="documentsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="dashboard-actions">
            <a href="{% url 'logout' %}" class="btn btn-secondary">Cerrar Sesión</a>
        </div>
    </div>
</div>

{% if role == "Supervisor" or role == "Jefe de Flota" and charts %}
<script>
// Datos para los gráficos
const statusLabels = {{ charts.status_labels|safe }};
const statusCounts = {{ charts.status_counts|safe }};
const serviceLabels = {{ charts.service_labels|safe }};
const serviceCounts = {{ charts.service_counts|safe }};
const trendLabels = {{ charts.trend_labels|safe }};
const trendCompleted = {{ charts.trend_completed|safe }};
const docTypeLabels = {{ charts.doc_type_labels|safe }};
const docTypeCounts = {{ charts.doc_type_counts|safe }};

// Colores para los gráficos
const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
    '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
];

// Gráfico de Barras: Órdenes por Estado
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'bar',
    data: {
        labels: statusLabels,
        datasets: [{
            label: 'Cantidad',
            data: statusCounts,
            backgroundColor: colors.slice(0, statusLabels.length),
            borderColor: colors.slice(0, statusLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});

// Gráfico Circular: Tipos de Servicio
const serviceCtx = document.getElementById('serviceChart').getContext('2d');
new Chart(serviceCtx, {
    type: 'doughnut',
    data: {
        labels: serviceLabels,
        datasets: [{
            data: serviceCounts,
            backgroundColor: colors.slice(0, serviceLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// Gráfico de Líneas: Tendencia Mensual
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: trendLabels,
        datasets: [{
            label: 'Órdenes Completadas',
            data: trendCompleted,
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});

// Gráfico de Barras: Documentos por Tipo
const documentsCtx = document.getElementById('documentsChart').getContext('2d');
new Chart(documentsCtx, {
    type: 'bar',
    data: {
        labels: docTypeLabels,
        datasets: [{
            label: 'Cantidad',
            data: docTypeCounts,
            backgroundColor: colors.slice(0, docTypeLabels.length),
            borderColor: colors.slice(0, docTypeLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}